<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="Sentinel1、初识 Sentinel1.1、雪崩问题及解决方案1.1.1、雪崩问题微服务中，服务间调用关系错综复杂，一个微服务往往依赖于多个其它微服务。  倘若服务提供者 I 发生故障，当前的应用的部分业务因为依赖于服务 I，因此也会被阻塞。此时，其它不依赖于服务 I 的业务似乎不受影响。  但是因为依赖服务 I 的业务请求被阻塞，使得用户不会得到响应，而且 Tomcat 的该业务线程也不会">
<meta property="og:type" content="article">
<meta property="og:title" content="Sentinel">
<meta property="og:url" content="http://myhikari.github.io/2023/03/16/Sentinel/index.html">
<meta property="og:site_name" content="myHikari">
<meta property="og:description" content="Sentinel1、初识 Sentinel1.1、雪崩问题及解决方案1.1.1、雪崩问题微服务中，服务间调用关系错综复杂，一个微服务往往依赖于多个其它微服务。  倘若服务提供者 I 发生故障，当前的应用的部分业务因为依赖于服务 I，因此也会被阻塞。此时，其它不依赖于服务 I 的业务似乎不受影响。  但是因为依赖服务 I 的业务请求被阻塞，使得用户不会得到响应，而且 Tomcat 的该业务线程也不会">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://myhikari.github.io/images/1533829099748.png">
<meta property="og:image" content="http://myhikari.github.io/images/1533829198240.png">
<meta property="og:image" content="http://myhikari.github.io/images/1533829307389.png">
<meta property="og:image" content="http://myhikari.github.io/images/image-20210715172710340.png">
<meta property="og:image" content="http://myhikari.github.io/images/image-20210715172820438.png">
<meta property="og:image" content="http://myhikari.github.io/images/image-20210715172946352.png">
<meta property="og:image" content="http://myhikari.github.io/images/image-20210715173215243.png">
<meta property="og:image" content="http://myhikari.github.io/images/image-20210715173327075.png">
<meta property="og:image" content="http://myhikari.github.io/images/image-20210715173428073.png">
<meta property="og:image" content="http://myhikari.github.io/images/image-20210715173555158.png">
<meta property="og:image" content="http://myhikari.github.io/images/image-20210715191757319.png">
<meta property="og:image" content="http://myhikari.github.io/images/image-20210715192010657.png">
<meta property="og:image" content="http://myhikari.github.io/images/image-20210715201827886.png">
<meta property="og:image" content="http://myhikari.github.io/images/image-20210715202540786.png">
<meta property="og:image" content="http://myhikari.github.io/images/image-20210716101805951.png">
<meta property="og:image" content="http://myhikari.github.io/images/image-20210716101934499.png">
<meta property="og:image" content="http://myhikari.github.io/images/image-20210716102103814.png">
<meta property="og:image" content="http://myhikari.github.io/images/image-20210716102416266.png">
<meta property="og:image" content="http://myhikari.github.io/images/image-20210716102532554.png">
<meta property="og:image" content="http://myhikari.github.io/images/image-20210716103536346.png">
<meta property="og:image" content="http://myhikari.github.io/images/image-20210716105227163.png">
<meta property="og:image" content="http://myhikari.github.io/images/image-20210716105408723.png">
<meta property="og:image" content="http://myhikari.github.io/images/image-20210716105612312.png">
<meta property="og:image" content="http://myhikari.github.io/images/image-20210716105812789.png">
<meta property="og:image" content="http://myhikari.github.io/images/image-20210716110027064.png">
<meta property="og:image" content="http://myhikari.github.io/images/image-20210716105855951.png">
<meta property="og:image" content="http://myhikari.github.io/images/image-20210716105956401.png">
<meta property="og:image" content="http://myhikari.github.io/images/image-20210716110225104.png">
<meta property="og:image" content="http://myhikari.github.io/images/image-20210716110629796.png">
<meta property="og:image" content="http://myhikari.github.io/images/image-20210716111012387.png">
<meta property="og:image" content="http://myhikari.github.io/images/image-20210716111136699.png">
<meta property="og:image" content="http://myhikari.github.io/images/image-20210716111303701.png">
<meta property="og:image" content="http://myhikari.github.io/images/image-20210716111404717.png">
<meta property="og:image" content="http://myhikari.github.io/images/image-20210716111526480.png">
<meta property="og:image" content="http://myhikari.github.io/images/image-20210716111658541.png">
<meta property="og:image" content="http://myhikari.github.io/images/image-20210716113147176.png">
<meta property="og:image" content="http://myhikari.github.io/images/image-20210716113426524.png">
<meta property="og:image" content="http://myhikari.github.io/images/image-20210716114048918.png">
<meta property="og:image" content="http://myhikari.github.io/images/image-20210716114243558.png">
<meta property="og:image" content="http://myhikari.github.io/images/image-20210716114429361.png">
<meta property="og:image" content="http://myhikari.github.io/images/image-20210716114522935.png">
<meta property="og:image" content="http://myhikari.github.io/images/image-20210716114651137.png">
<meta property="og:image" content="http://myhikari.github.io/images/image-20210716115014663.png">
<meta property="og:image" content="http://myhikari.github.io/images/image-20210716115131463.png">
<meta property="og:image" content="d:/BaiDuDisk/BaiduNetdiskDownload/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/day01-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4/%E8%AE%B2%E4%B9%89/assets/image-20210716115232426.png">
<meta property="og:image" content="d:/BaiDuDisk/BaiduNetdiskDownload/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/day01-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4/%E8%AE%B2%E4%B9%89/assets/image-20210716115717523.png">
<meta property="og:image" content="d:/BaiDuDisk/BaiduNetdiskDownload/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/day01-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4/%E8%AE%B2%E4%B9%89/assets/image-20210716120033572.png">
<meta property="og:image" content="d:/BaiDuDisk/BaiduNetdiskDownload/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/day01-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4/%E8%AE%B2%E4%B9%89/assets/image-20210716120208509.png">
<meta property="og:image" content="d:/BaiDuDisk/BaiduNetdiskDownload/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/day01-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4/%E8%AE%B2%E4%B9%89/assets/image-20210716120319009.png">
<meta property="og:image" content="d:/BaiDuDisk/BaiduNetdiskDownload/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/day01-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4/%E8%AE%B2%E4%B9%89/assets/image-20210716120536714.png">
<meta property="og:image" content="d:/BaiDuDisk/BaiduNetdiskDownload/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/day01-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4/%E8%AE%B2%E4%B9%89/assets/image-20210716120754527.png">
<meta property="og:image" content="d:/BaiDuDisk/BaiduNetdiskDownload/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/day01-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4/%E8%AE%B2%E4%B9%89/assets/image-20210716120840501.png">
<meta property="og:image" content="d:/BaiDuDisk/BaiduNetdiskDownload/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/day01-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4/%E8%AE%B2%E4%B9%89/assets/image-20210716121105567.png">
<meta property="og:image" content="d:/BaiDuDisk/BaiduNetdiskDownload/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/day01-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4/%E8%AE%B2%E4%B9%89/assets/image-20210716120900365.png">
<meta property="og:image" content="d:/BaiDuDisk/BaiduNetdiskDownload/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/day01-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4/%E8%AE%B2%E4%B9%89/assets/image-20210716121201630.png">
<meta property="og:image" content="d:/BaiDuDisk/BaiduNetdiskDownload/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/day01-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4/%E8%AE%B2%E4%B9%89/assets/image-20210716120919131.png">
<meta property="og:image" content="d:/BaiDuDisk/BaiduNetdiskDownload/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/day01-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4/%E8%AE%B2%E4%B9%89/assets/image-20210716121220305.png">
<meta property="og:image" content="d:/BaiDuDisk/BaiduNetdiskDownload/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/day01-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4/%E8%AE%B2%E4%B9%89/assets/image-20210715173215243.png">
<meta property="og:image" content="d:/BaiDuDisk/BaiduNetdiskDownload/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/day01-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4/%E8%AE%B2%E4%B9%89/assets/image-20210715173428073.png">
<meta property="og:image" content="d:/BaiDuDisk/BaiduNetdiskDownload/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/day01-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4/%E8%AE%B2%E4%B9%89/assets/image-20210716122403502.png">
<meta property="og:image" content="d:/BaiDuDisk/BaiduNetdiskDownload/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/day01-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4/%E8%AE%B2%E4%B9%89/assets/image-20210716123705780.png">
<meta property="og:image" content="d:/BaiDuDisk/BaiduNetdiskDownload/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/day01-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4/%E8%AE%B2%E4%B9%89/assets/image-20210716123036937.png">
<meta property="og:image" content="d:/BaiDuDisk/BaiduNetdiskDownload/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/day01-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4/%E8%AE%B2%E4%B9%89/assets/image-20210716123240518.png">
<meta property="og:image" content="d:/BaiDuDisk/BaiduNetdiskDownload/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/day01-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4/%E8%AE%B2%E4%B9%89/assets/image-20210716123411217.png">
<meta property="og:image" content="d:/BaiDuDisk/BaiduNetdiskDownload/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/day01-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4/%E8%AE%B2%E4%B9%89/assets/image-20210716123831992.png">
<meta property="og:image" content="d:/BaiDuDisk/BaiduNetdiskDownload/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/day01-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4/%E8%AE%B2%E4%B9%89/assets/image-20210716123936844.png">
<meta property="og:image" content="d:/BaiDuDisk/BaiduNetdiskDownload/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/day01-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4/%E8%AE%B2%E4%B9%89/assets/image-20210716124229894.png">
<meta property="og:image" content="d:/BaiDuDisk/BaiduNetdiskDownload/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/day01-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4/%E8%AE%B2%E4%B9%89/assets/image-20210716124147820.png">
<meta property="og:image" content="d:/BaiDuDisk/BaiduNetdiskDownload/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/day01-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4/%E8%AE%B2%E4%B9%89/assets/image-20210716130958518.png">
<meta property="og:image" content="d:/BaiDuDisk/BaiduNetdiskDownload/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/day01-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4/%E8%AE%B2%E4%B9%89/assets/image-20210716145934347.png">
<meta property="og:image" content="d:/BaiDuDisk/BaiduNetdiskDownload/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/day01-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4/%E8%AE%B2%E4%B9%89/assets/image-20210716150234787.png">
<meta property="og:image" content="d:/BaiDuDisk/BaiduNetdiskDownload/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/day01-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4/%E8%AE%B2%E4%B9%89/assets/image-20210716150510956.png">
<meta property="og:image" content="d:/BaiDuDisk/BaiduNetdiskDownload/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/day01-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4/%E8%AE%B2%E4%B9%89/assets/image-20210716150605208.png">
<meta property="og:image" content="d:/BaiDuDisk/BaiduNetdiskDownload/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/day01-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4/%E8%AE%B2%E4%B9%89/assets/image-20210716150654094.png">
<meta property="og:image" content="d:/BaiDuDisk/BaiduNetdiskDownload/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/day01-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4/%E8%AE%B2%E4%B9%89/assets/image-20210716150740434.png">
<meta property="og:image" content="d:/BaiDuDisk/BaiduNetdiskDownload/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/day01-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4/%E8%AE%B2%E4%B9%89/assets/image-20210716150911004.png">
<meta property="og:image" content="d:/BaiDuDisk/BaiduNetdiskDownload/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/day01-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4/%E8%AE%B2%E4%B9%89/assets/image-20210716151107785.png">
<meta property="og:image" content="d:/BaiDuDisk/BaiduNetdiskDownload/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/day01-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4/%E8%AE%B2%E4%B9%89/assets/image-20210716131430682.png">
<meta property="og:image" content="d:/BaiDuDisk/BaiduNetdiskDownload/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/day01-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4/%E8%AE%B2%E4%B9%89/assets/image-20210716131522912.png">
<meta property="og:image" content="d:/BaiDuDisk/BaiduNetdiskDownload/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/day01-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4/%E8%AE%B2%E4%B9%89/assets/image-20210716151348183.png">
<meta property="og:image" content="d:/BaiDuDisk/BaiduNetdiskDownload/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/day01-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4/%E8%AE%B2%E4%B9%89/assets/image-20210716150654094.png">
<meta property="og:image" content="d:/BaiDuDisk/BaiduNetdiskDownload/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/day01-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4/%E8%AE%B2%E4%B9%89/assets/image-20210716151538785.png">
<meta property="og:image" content="d:/BaiDuDisk/BaiduNetdiskDownload/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/day01-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4/%E8%AE%B2%E4%B9%89/assets/image-20210716151722916.png">
<meta property="og:image" content="d:/BaiDuDisk/BaiduNetdiskDownload/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/day01-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4/%E8%AE%B2%E4%B9%89/assets/image-20210716151844817.png">
<meta property="og:image" content="d:/BaiDuDisk/BaiduNetdiskDownload/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/day01-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4/%E8%AE%B2%E4%B9%89/assets/image-20210716152010750.png">
<meta property="og:image" content="d:/BaiDuDisk/BaiduNetdiskDownload/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/day01-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4/%E8%AE%B2%E4%B9%89/assets/image-20210716152349191.png">
<meta property="og:image" content="d:/BaiDuDisk/BaiduNetdiskDownload/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/day01-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4/%E8%AE%B2%E4%B9%89/assets/image-20210716153250134.png">
<meta property="og:image" content="d:/BaiDuDisk/BaiduNetdiskDownload/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/day01-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4/%E8%AE%B2%E4%B9%89/assets/image-20210716153301069.png">
<meta property="og:image" content="d:/BaiDuDisk/BaiduNetdiskDownload/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/day01-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4/%E8%AE%B2%E4%B9%89/assets/image-20210716153348396.png">
<meta property="og:image" content="d:/BaiDuDisk/BaiduNetdiskDownload/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/day01-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4/%E8%AE%B2%E4%B9%89/assets/image-20210716153434095.png">
<meta property="og:image" content="d:/BaiDuDisk/BaiduNetdiskDownload/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/day01-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4/%E8%AE%B2%E4%B9%89/assets/image-20210716153938887.png">
<meta property="og:image" content="d:/BaiDuDisk/BaiduNetdiskDownload/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/day01-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4/%E8%AE%B2%E4%B9%89/assets/image-20210716154012736.png">
<meta property="og:image" content="d:/BaiDuDisk/BaiduNetdiskDownload/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/day01-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4/%E8%AE%B2%E4%B9%89/assets/image-20210716154155238.png">
<meta property="og:image" content="d:/BaiDuDisk/BaiduNetdiskDownload/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/day01-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4/%E8%AE%B2%E4%B9%89/assets/image-20210716154215456.png">
<meta property="og:image" content="http://myhikari.github.io/assets/image-20210716154255466.png">
<meta property="article:published_time" content="2023-03-16T06:15:32.000Z">
<meta property="article:modified_time" content="2024-05-16T10:18:06.113Z">
<meta property="article:author" content="myHikari">
<meta property="article:tag" content="Sentinel">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://myhikari.github.io/images/1533829099748.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>Sentinel</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.2.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="目录"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="目录"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="顶部" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">首页</a></li><!--
     --><!--
       --><li><a href="/about/">关于</a></li><!--
     --><!--
       --><li><a href="/archives/">归档</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/myHikari">项目</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="上一篇" href="/2023/03/16/RabbitMQ/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="下一篇" href="/2022/07/06/Zuul-Gateway/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="返回顶部" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="分享文章" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://myhikari.github.io/2023/03/16/Sentinel/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://myhikari.github.io/2023/03/16/Sentinel/&text=Sentinel"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://myhikari.github.io/2023/03/16/Sentinel/&title=Sentinel"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://myhikari.github.io/2023/03/16/Sentinel/&is_video=false&description=Sentinel"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Sentinel&body=Check out this article: http://myhikari.github.io/2023/03/16/Sentinel/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://myhikari.github.io/2023/03/16/Sentinel/&title=Sentinel"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://myhikari.github.io/2023/03/16/Sentinel/&title=Sentinel"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://myhikari.github.io/2023/03/16/Sentinel/&title=Sentinel"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://myhikari.github.io/2023/03/16/Sentinel/&title=Sentinel"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://myhikari.github.io/2023/03/16/Sentinel/&name=Sentinel&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://myhikari.github.io/2023/03/16/Sentinel/&t=Sentinel"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Sentinel"><span class="toc-number">1.</span> <span class="toc-text">Sentinel</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E5%88%9D%E8%AF%86-Sentinel"><span class="toc-number">1.1.</span> <span class="toc-text">1、初识 Sentinel</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1%E3%80%81%E9%9B%AA%E5%B4%A9%E9%97%AE%E9%A2%98%E5%8F%8A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.1、雪崩问题及解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-1%E3%80%81%E9%9B%AA%E5%B4%A9%E9%97%AE%E9%A2%98"><span class="toc-number">1.1.1.1.</span> <span class="toc-text">1.1.1、雪崩问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-2%E3%80%81%E8%B6%85%E6%97%B6%E5%A4%84%E7%90%86"><span class="toc-number">1.1.1.2.</span> <span class="toc-text">1.1.2、超时处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-3%E3%80%81%E4%BB%93%E5%A3%81%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.1.1.3.</span> <span class="toc-text">1.1.3、仓壁模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-4%E3%80%81%E6%96%AD%E8%B7%AF%E5%99%A8"><span class="toc-number">1.1.1.4.</span> <span class="toc-text">1.1.4、断路器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-5%E3%80%81%E9%99%90%E6%B5%81"><span class="toc-number">1.1.1.5.</span> <span class="toc-text">1.1.5、限流</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-6%E3%80%81%E6%80%BB%E7%BB%93"><span class="toc-number">1.1.1.6.</span> <span class="toc-text">1.1.6、总结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2%E3%80%81%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4%E6%8A%80%E6%9C%AF%E5%AF%B9%E6%AF%94"><span class="toc-number">1.1.2.</span> <span class="toc-text">1.2、服务保护技术对比</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3%E3%80%81Sentinel-%E4%BB%8B%E7%BB%8D%E5%92%8C%E5%AE%89%E8%A3%85"><span class="toc-number">1.1.3.</span> <span class="toc-text">1.3、Sentinel 介绍和安装</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-1%E3%80%81%E5%88%9D%E8%AF%86-Sentinel"><span class="toc-number">1.1.3.1.</span> <span class="toc-text">1.3.1、初识 Sentinel</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-2%E3%80%81%E5%AE%89%E8%A3%85-Sentinel"><span class="toc-number">1.1.3.2.</span> <span class="toc-text">1.3.2、安装 Sentinel</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4%E3%80%81%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%95%B4%E5%90%88-Sentinel"><span class="toc-number">1.1.4.</span> <span class="toc-text">1.4、微服务整合 Sentinel</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6"><span class="toc-number">1.2.</span> <span class="toc-text">2、流量控制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1%E3%80%81%E7%B0%87%E7%82%B9%E9%93%BE%E8%B7%AF"><span class="toc-number">1.2.1.</span> <span class="toc-text">2.1、簇点链路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1%E3%80%81%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.1、快速入门</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2%E3%80%81%E6%B5%81%E6%8E%A7%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.2.3.</span> <span class="toc-text">2.2、流控模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1%E3%80%81%E5%85%B3%E8%81%94%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">2.2.1、关联模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-2%E3%80%81%E9%93%BE%E8%B7%AF%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.2.3.2.</span> <span class="toc-text">2.2.2、链路模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-3-%E6%80%BB%E7%BB%93"><span class="toc-number">1.2.3.3.</span> <span class="toc-text">2.2.3.总结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3%E3%80%81%E6%B5%81%E6%8E%A7%E6%95%88%E6%9E%9C"><span class="toc-number">1.2.4.</span> <span class="toc-text">2.3、流控效果</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-1%E3%80%81warm-up"><span class="toc-number">1.2.4.1.</span> <span class="toc-text">2.3.1、warm up</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B"><span class="toc-number">1.2.4.1.1.</span> <span class="toc-text">案例</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-2%E3%80%81%E6%8E%92%E9%98%9F%E7%AD%89%E5%BE%85"><span class="toc-number">1.2.4.2.</span> <span class="toc-text">2.3.2、排队等待</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B-1"><span class="toc-number">1.2.4.2.1.</span> <span class="toc-text">案例</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-3"><span class="toc-number">1.2.4.3.</span> <span class="toc-text">2.3.3</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">1.2.4.4.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4%E3%80%81%E7%83%AD%E7%82%B9%E5%8F%82%E6%95%B0%E9%99%90%E6%B5%81"><span class="toc-number">1.2.5.</span> <span class="toc-text">2.4、热点参数限流</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4-1%E3%80%81%E5%85%A8%E5%B1%80%E5%8F%82%E6%95%B0%E9%99%90%E6%B5%81"><span class="toc-number">1.2.5.0.1.</span> <span class="toc-text">2.4.1、全局参数限流</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4-2%E3%80%81%E7%83%AD%E7%82%B9%E5%8F%82%E6%95%B0%E9%99%90%E6%B5%81"><span class="toc-number">1.2.5.0.2.</span> <span class="toc-text">2.4.2、热点参数限流</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4-3%E3%80%81%E6%A1%88%E4%BE%8B"><span class="toc-number">1.2.5.0.3.</span> <span class="toc-text">2.4.3、案例</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-%E9%9A%94%E7%A6%BB%E5%92%8C%E9%99%8D%E7%BA%A7"><span class="toc-number">2.</span> <span class="toc-text">3.隔离和降级</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-FeignClient-%E6%95%B4%E5%90%88-Sentinel"><span class="toc-number">2.1.</span> <span class="toc-text">3.1.FeignClient 整合 Sentinel</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-1-%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%EF%BC%8C%E5%BC%80%E5%90%AF-sentinel-%E5%8A%9F%E8%83%BD"><span class="toc-number">2.1.1.</span> <span class="toc-text">3.1.1.修改配置，开启 sentinel 功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-2-%E7%BC%96%E5%86%99%E5%A4%B1%E8%B4%A5%E9%99%8D%E7%BA%A7%E9%80%BB%E8%BE%91"><span class="toc-number">2.1.2.</span> <span class="toc-text">3.1.2.编写失败降级逻辑</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-3-%E6%80%BB%E7%BB%93"><span class="toc-number">2.1.3.</span> <span class="toc-text">3.1.3.总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-%E7%BA%BF%E7%A8%8B%E9%9A%94%E7%A6%BB%EF%BC%88%E8%88%B1%E5%A3%81%E6%A8%A1%E5%BC%8F%EF%BC%89"><span class="toc-number">2.2.</span> <span class="toc-text">3.2.线程隔离（舱壁模式）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-1-%E7%BA%BF%E7%A8%8B%E9%9A%94%E7%A6%BB%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F"><span class="toc-number">2.2.1.</span> <span class="toc-text">3.2.1.线程隔离的实现方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-2-sentinel-%E7%9A%84%E7%BA%BF%E7%A8%8B%E9%9A%94%E7%A6%BB"><span class="toc-number">2.2.2.</span> <span class="toc-text">3.2.2.sentinel 的线程隔离</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%EF%BC%89%E9%85%8D%E7%BD%AE%E9%9A%94%E7%A6%BB%E8%A7%84%E5%88%99"><span class="toc-number">2.2.2.1.</span> <span class="toc-text">1）配置隔离规则</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%EF%BC%89Jmeter-%E6%B5%8B%E8%AF%95"><span class="toc-number">2.2.2.2.</span> <span class="toc-text">2）Jmeter 测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-3-%E6%80%BB%E7%BB%93"><span class="toc-number">2.2.3.</span> <span class="toc-text">3.2.3.总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7"><span class="toc-number">2.3.</span> <span class="toc-text">3.3.熔断降级</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-1-%E6%85%A2%E8%B0%83%E7%94%A8"><span class="toc-number">2.3.1.</span> <span class="toc-text">3.3.1.慢调用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%EF%BC%89%E8%AE%BE%E7%BD%AE%E6%85%A2%E8%B0%83%E7%94%A8"><span class="toc-number">2.3.1.1.</span> <span class="toc-text">1）设置慢调用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%EF%BC%89%E8%AE%BE%E7%BD%AE%E7%86%94%E6%96%AD%E8%A7%84%E5%88%99"><span class="toc-number">2.3.1.2.</span> <span class="toc-text">2）设置熔断规则</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%EF%BC%89%E6%B5%8B%E8%AF%95"><span class="toc-number">2.3.1.3.</span> <span class="toc-text">3）测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-2-%E5%BC%82%E5%B8%B8%E6%AF%94%E4%BE%8B%E3%80%81%E5%BC%82%E5%B8%B8%E6%95%B0"><span class="toc-number">2.3.2.</span> <span class="toc-text">3.3.2.异常比例、异常数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%EF%BC%89%E8%AE%BE%E7%BD%AE%E5%BC%82%E5%B8%B8%E8%AF%B7%E6%B1%82"><span class="toc-number">2.3.2.1.</span> <span class="toc-text">1）设置异常请求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%EF%BC%89%E8%AE%BE%E7%BD%AE%E7%86%94%E6%96%AD%E8%A7%84%E5%88%99-1"><span class="toc-number">2.3.2.2.</span> <span class="toc-text">2）设置熔断规则</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%EF%BC%89%E6%B5%8B%E8%AF%95-1"><span class="toc-number">2.3.2.3.</span> <span class="toc-text">3）测试</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-%E6%8E%88%E6%9D%83%E8%A7%84%E5%88%99"><span class="toc-number">3.</span> <span class="toc-text">4.授权规则</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-%E6%8E%88%E6%9D%83%E8%A7%84%E5%88%99"><span class="toc-number">3.1.</span> <span class="toc-text">4.1.授权规则</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-1-%E5%9F%BA%E6%9C%AC%E8%A7%84%E5%88%99"><span class="toc-number">3.1.1.</span> <span class="toc-text">4.1.1.基本规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-2-%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96-origin"><span class="toc-number">3.1.2.</span> <span class="toc-text">4.1.2.如何获取 origin</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-3-%E7%BB%99%E7%BD%91%E5%85%B3%E6%B7%BB%E5%8A%A0%E8%AF%B7%E6%B1%82%E5%A4%B4"><span class="toc-number">3.1.3.</span> <span class="toc-text">4.1.3.给网关添加请求头</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-4-%E9%85%8D%E7%BD%AE%E6%8E%88%E6%9D%83%E8%A7%84%E5%88%99"><span class="toc-number">3.1.4.</span> <span class="toc-text">4.1.4.配置授权规则</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BC%82%E5%B8%B8%E7%BB%93%E6%9E%9C"><span class="toc-number">3.2.</span> <span class="toc-text">4.2.自定义异常结果</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-1-%E5%BC%82%E5%B8%B8%E7%B1%BB%E5%9E%8B"><span class="toc-number">3.2.1.</span> <span class="toc-text">4.2.1.异常类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-2-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-number">3.2.2.</span> <span class="toc-text">4.2.2.自定义异常处理</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-%E8%A7%84%E5%88%99%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">4.</span> <span class="toc-text">5.规则持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-%E8%A7%84%E5%88%99%E7%AE%A1%E7%90%86%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.1.</span> <span class="toc-text">5.1.规则管理模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-1-pull-%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.1.1.</span> <span class="toc-text">5.1.1.pull 模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-2-push-%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.1.2.</span> <span class="toc-text">5.1.2.push 模式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-%E5%AE%9E%E7%8E%B0-push-%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.2.</span> <span class="toc-text">5.2.实现 push 模式</span></a></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        Sentinel
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">myHikari</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-03-16T06:15:32.000Z" class="dt-published" itemprop="datePublished">2023-03-16</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/Sentinel/">Sentinel</a>
    </div>


      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/Sentinel/" rel="tag">Sentinel</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h1 id="Sentinel"><a href="#Sentinel" class="headerlink" title="Sentinel"></a>Sentinel</h1><h2 id="1、初识-Sentinel"><a href="#1、初识-Sentinel" class="headerlink" title="1、初识 Sentinel"></a>1、初识 Sentinel</h2><h3 id="1-1、雪崩问题及解决方案"><a href="#1-1、雪崩问题及解决方案" class="headerlink" title="1.1、雪崩问题及解决方案"></a>1.1、雪崩问题及解决方案</h3><h4 id="1-1-1、雪崩问题"><a href="#1-1-1、雪崩问题" class="headerlink" title="1.1.1、雪崩问题"></a>1.1.1、雪崩问题</h4><p>微服务中，服务间调用关系错综复杂，一个微服务往往依赖于多个其它微服务。</p>
<p><img src="/images/1533829099748.png" alt="1533829099748"></p>
<p>倘若服务提供者 I 发生故障，当前的应用的部分业务因为依赖于服务 I，因此也会被阻塞。此时，其它不依赖于服务 I 的业务似乎不受影响。</p>
<p><img src="/images/1533829198240.png" alt="1533829198240"></p>
<p>但是因为依赖服务 I 的业务请求被阻塞，使得用户不会得到响应，而且 Tomcat 的该业务线程也不会释放，于是越来越多的用户请求到来，越来越多的线程会阻塞</p>
<p><img src="/images/1533829307389.png" alt="1533829307389"></p>
<p>服务器支持的线程和并发数有限，请求一直阻塞，会导致服务器资源耗尽，从而导致所有其它服务都不可用，那么当前服务也就不可用。</p>
<p>那么，依赖于当前服务的其它服务随着时间的推移，最终也都会变的不可用，形成级联失败，雪崩就此发生了。</p>
<p><img src="/images/image-20210715172710340.png" alt="image-20210715172710340"></p>
<blockquote>
<p>解决雪崩问题的常见方式：</p>
<ol>
<li>超时处理</li>
<li>仓壁模式</li>
<li>断路器</li>
<li>限流</li>
</ol>
</blockquote>
<h4 id="1-1-2、超时处理"><a href="#1-1-2、超时处理" class="headerlink" title="1.1.2、超时处理"></a>1.1.2、超时处理</h4><p>超时处理：设定超时时间。请求超过一定时间没有响应就返回错误信息，不会无休止等待</p>
<p><img src="/images/image-20210715172820438.png" alt="image-20210715172820438"></p>
<h4 id="1-1-3、仓壁模式"><a href="#1-1-3、仓壁模式" class="headerlink" title="1.1.3、仓壁模式"></a>1.1.3、仓壁模式</h4><p>仓壁模式来源于船舱的设计：</p>
<p><img src="/images/image-20210715172946352.png" alt="image-20210715172946352"></p>
<p>船舱都会被隔板分离为多个独立空间，当船体破损时，只会导致部分空间进入，将故障控制在一定范围内，避免整个船体都被淹没。</p>
<p>于此类似，通过限定每个业务能使用的线程数，避免耗尽整个 tomcat 的资源，因此也叫线程隔离。</p>
<p><img src="/images/image-20210715173215243.png" alt="image-20210715173215243"></p>
<h4 id="1-1-4、断路器"><a href="#1-1-4、断路器" class="headerlink" title="1.1.4、断路器"></a>1.1.4、断路器</h4><p>断路器模式：由<strong>断路器</strong>统计业务执行的异常比例，如果超出阈值则会<strong>熔断</strong>该业务，拦截访问该业务的一切请求。</p>
<p>断路器会统计访问某个服务的请求数量，异常比例：</p>
<p><img src="/images/image-20210715173327075.png" alt="image-20210715173327075"></p>
<p>当发现访问服务 D 的请求异常比例过高时，认为服务 D 有导致雪崩的风险，会拦截访问服务 D 的一切请求，形成熔断：</p>
<p><img src="/images/image-20210715173428073.png" alt="image-20210715173428073"></p>
<h4 id="1-1-5、限流"><a href="#1-1-5、限流" class="headerlink" title="1.1.5、限流"></a>1.1.5、限流</h4><p><strong>流量控制</strong>：限制业务访问的 QPS，避免服务因流量的突增而故障。</p>
<p><img src="/images/image-20210715173555158.png" alt="image-20210715173555158"></p>
<h4 id="1-1-6、总结"><a href="#1-1-6、总结" class="headerlink" title="1.1.6、总结"></a>1.1.6、总结</h4><p>什么是雪崩问题？</p>
<ul>
<li>微服务之间相互调用，因为调用链中的一个服务故障，引起整个链路都无法访问的情况。</li>
</ul>
<p>面对雪崩问题的应对方法：</p>
<p><strong>限流</strong>是对服务的保护，避免因瞬间高并发流量而导致服务故障，进而避免雪崩。是一种<strong>预防</strong>措施。</p>
<p><strong>超时处理、线程隔离、降级熔断</strong>是在部分服务故障时，将故障控制在一定范围，避免雪崩。是一种<strong>补救</strong>措施。</p>
<h3 id="1-2、服务保护技术对比"><a href="#1-2、服务保护技术对比" class="headerlink" title="1.2、服务保护技术对比"></a>1.2、服务保护技术对比</h3><p>在 SpringCloud 当中支持多种服务保护技术：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/Netflix/Hystrix">Netfix Hystrix</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel">Sentinel</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/resilience4j/resilience4j">Resilience4J</a></li>
</ul>
<p>早期比较流行的是 Hystrix 框架，但目前国内实用最广泛的还是阿里巴巴的 Sentinel 框架，这里我们做下对比：</p>
<table>
<thead>
<tr>
<th></th>
<th><strong>Sentinel</strong></th>
<th><strong>Hystrix</strong></th>
</tr>
</thead>
<tbody><tr>
<td>隔离策略</td>
<td>信号量隔离</td>
<td>线程池隔离&#x2F;信号量隔离</td>
</tr>
<tr>
<td>熔断降级策略</td>
<td>基于慢调用比例或异常比例</td>
<td>基于失败比率</td>
</tr>
<tr>
<td>实时指标实现</td>
<td>滑动窗口</td>
<td>滑动窗口（基于 RxJava）</td>
</tr>
<tr>
<td>规则配置</td>
<td>支持多种数据源</td>
<td>支持多种数据源</td>
</tr>
<tr>
<td>扩展性</td>
<td>多个扩展点</td>
<td>插件的形式</td>
</tr>
<tr>
<td>基于注解的支持</td>
<td>支持</td>
<td>支持</td>
</tr>
<tr>
<td>限流</td>
<td>基于 QPS，支持基于调用关系的限流</td>
<td>有限的支持</td>
</tr>
<tr>
<td>流量整形</td>
<td>支持慢启动、匀速排队模式</td>
<td>不支持</td>
</tr>
<tr>
<td>系统自适应保护</td>
<td>支持</td>
<td>不支持</td>
</tr>
<tr>
<td>控制台</td>
<td>开箱即用，可配置规则、查看秒级监控、机器发现等</td>
<td>不完善</td>
</tr>
<tr>
<td>常见框架的适配</td>
<td>Servlet、Spring Cloud、Dubbo、gRPC 等</td>
<td>Servlet、Spring Cloud Netflix</td>
</tr>
</tbody></table>
<h3 id="1-3、Sentinel-介绍和安装"><a href="#1-3、Sentinel-介绍和安装" class="headerlink" title="1.3、Sentinel 介绍和安装"></a>1.3、Sentinel 介绍和安装</h3><h4 id="1-3-1、初识-Sentinel"><a href="#1-3-1、初识-Sentinel" class="headerlink" title="1.3.1、初识 Sentinel"></a>1.3.1、初识 Sentinel</h4><p>Sentinel 是阿里巴巴开源的一款微服务流量控制组件。官网地址：<a target="_blank" rel="noopener" href="https://sentinelguard.io/zh-cn/index.html">https://sentinelguard.io/zh-cn/index.html</a></p>
<p>Sentinel 具有以下特征:</p>
<ul>
<li><strong>丰富的应用场景</strong>：秒杀（即突发流量控制在系统容量可承受的范围）、消息削峰填谷、集群流量控制、实时熔断下游不可用应用等。</li>
<li><strong>完备的实时监控</strong>：Sentinel 同时提供实时的监控功能。可以在控制台中看到接入应用的单台机器秒级数据，甚至 500 台以下规模的集群的汇总运行情况。</li>
<li><strong>广泛的开源生态</strong>：Sentinel 提供开箱即用的与其它开源框架&#x2F;库的整合模块，例如与 Spring Cloud、Dubbo、gRPC 的整合。</li>
<li><strong>完善的</strong> <strong>SPI</strong> <strong>扩展点</strong>：Sentinel 提供简单易用、完善的 SPI 扩展接口。只需通过实现扩展接口来快速地定制逻辑。</li>
</ul>
<h4 id="1-3-2、安装-Sentinel"><a href="#1-3-2、安装-Sentinel" class="headerlink" title="1.3.2、安装 Sentinel"></a>1.3.2、安装 Sentinel</h4><blockquote>
<p>下载地址：<a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/releases">sentinel-GitHub</a></p>
</blockquote>
<p>运行-&gt;将 jar 包放到任意非中文目录，执行命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar sentinel-dashboard-1.8.1.jar</span><br></pre></td></tr></table></figure>

<p>如果要修改 Sentinel 的默认端口、账户、密码，可以通过下列配置：</p>
<table>
<thead>
<tr>
<th><strong>配置项</strong></th>
<th><strong>默认值</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>server.port</td>
<td>8080</td>
<td>服务端口</td>
</tr>
<tr>
<td>sentinel.dashboard.auth.username</td>
<td>sentinel</td>
<td>默认用户名</td>
</tr>
<tr>
<td>sentinel.dashboard.auth.password</td>
<td>sentinel</td>
<td>默认密码</td>
</tr>
</tbody></table>
<p>例如修改端口：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Dserver.port=8090 -jar sentinel-dashboard-1.8.1.jar</span><br></pre></td></tr></table></figure>

<blockquote>
<p>sentinel 的控制台访问地址：<a target="_blank" rel="noopener" href="http://localhost:8080/">http://localhost:8080</a></p>
</blockquote>
<h3 id="1-4、微服务整合-Sentinel"><a href="#1-4、微服务整合-Sentinel" class="headerlink" title="1.4、微服务整合 Sentinel"></a>1.4、微服务整合 Sentinel</h3><p>1）引入 sentinel 依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--sentinel--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2）配置控制台</p>
<p>修改 application.yaml 文件，添加下面内容：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="string">localhost:8080</span></span><br></pre></td></tr></table></figure>

<p>3）浏览器访问 service 的任意端点即可触发 sentinel 的监控</p>
<h2 id="2、流量控制"><a href="#2、流量控制" class="headerlink" title="2、流量控制"></a>2、流量控制</h2><p>限流是避免服务因突发的流量而发生故障，是对微服务雪崩问题的预防。</p>
<h3 id="2-1、簇点链路"><a href="#2-1、簇点链路" class="headerlink" title="2.1、簇点链路"></a>2.1、簇点链路</h3><ul>
<li>当请求进入微服务时，首先会访问 DispatcherServlet，然后进入 Controller、Service、Mapper，这调用链就叫做<strong>簇点链路</strong>。</li>
<li>簇点链路中被监控的每一个接口就是一个<strong>资源</strong>。</li>
<li>默认情况下 sentinel 会监控 SpringMVC 的每一个端点（Endpoint，也就是 controller 中的方法），因此 SpringMVC 的每一个端点（Endpoint）就是调用链路中的一个资源。</li>
</ul>
<p>流控、熔断等都是针对簇点链路中的资源来设置的，因此点击对应资源后面的按钮来设置规则（如下图）：</p>
<ul>
<li>流控：流量控制</li>
<li>降级：降级熔断</li>
<li>热点：热点参数限流，是限流的一种</li>
<li>授权：请求的权限控制</li>
</ul>
<p><img src="/images/image-20210715191757319.png" alt="image-20210715191757319"></p>
<h3 id="2-1、快速入门"><a href="#2-1、快速入门" class="headerlink" title="2.1、快速入门"></a>2.1、快速入门</h3><p>点击资源&#x2F;order&#x2F;{orderId}后面的流控按钮弹出表单，在表单中填写限流规则，如下：</p>
<p><img src="/images/image-20210715192010657.png" alt="image-20210715192010657"></p>
<p>其含义是限制 &#x2F;order&#x2F;{orderId}该资源的单机 QPS 为 1，即每秒只允许 1 次请求，超出的请求会被拦截并报错。</p>
<h3 id="2-2、流控模式"><a href="#2-2、流控模式" class="headerlink" title="2.2、流控模式"></a>2.2、流控模式</h3><p>在添加限流规则时，点击高级选项，可以选择三种<strong>流控模式</strong>：</p>
<ul>
<li>直接：统计当前资源的请求，触发阈值时对当前资源直接限流，也是默认的模式</li>
<li>关联：统计与当前资源相关的另一个资源，触发阈值时，对当前资源限流</li>
<li>链路：统计从指定链路访问到本资源的请求，触发阈值时，对指定链路限流</li>
</ul>
<p><img src="/images/image-20210715201827886.png" alt="image-20210715201827886"></p>
<h4 id="2-2-1、关联模式"><a href="#2-2-1、关联模式" class="headerlink" title="2.2.1、关联模式"></a>2.2.1、关联模式</h4><p><strong>关联模式</strong>：统计与当前资源相关的另一个资源，触发阈值时，对当前资源限流</p>
<p><strong>配置规则</strong>：</p>
<p><img src="/images/image-20210715202540786.png" alt="image-20210715202540786"></p>
<p><strong>语法说明</strong>：当&#x2F;write 资源访问量触发阈值时，就会对&#x2F;read 资源限流，避免影响&#x2F;write 资源。</p>
<p><strong>使用场景</strong>：比如用户支付时需要修改订单状态，同时用户要查询订单。查询和修改操作会争抢数据库锁，产生竞争。业务需求是优先支付和更新订单的业务，因此当修改订单业务触发阈值时，需要对查询订单业务限流。</p>
<p><strong>需求说明</strong>：</p>
<ul>
<li><p>在 OrderController 新建两个端点：&#x2F;order&#x2F;query 和&#x2F;order&#x2F;update，无需实现业务</p>
</li>
<li><p>配置流控规则，当&#x2F;order&#x2F;update 资源被访问的 QPS 超过 5 时，对&#x2F;order&#x2F;query 请求限流</p>
</li>
</ul>
<p>1）定义&#x2F;order&#x2F;query 端点，模拟订单查询</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/query&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">queryOrder</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;查询订单成功&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2）定义&#x2F;order&#x2F;update 端点，模拟订单更新</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/update&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">updateOrder</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;更新订单成功&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重启服务，查看 sentinel 控制台的簇点链路：</p>
<p><img src="/images/image-20210716101805951.png" alt="image-20210716101805951"></p>
<p>3）配置流控规则</p>
<p>对订单查询&#x2F;order&#x2F;query 限流按钮</p>
<p><img src="/images/image-20210716101934499.png" alt="image-20210716101934499"></p>
<p>在表单中填写流控规则：</p>
<p><img src="/images/image-20210716102103814.png" alt="image-20210716102103814"></p>
<p>4）在 Jmeter 测试</p>
<p>选择《流控模式-关联》：设置 100 秒内 1000 个线程，因此 QPS 为 10，超过设定的阈值 5</p>
<p><img src="/images/image-20210716102416266.png" alt="image-20210716102416266"></p>
<p>查看 http 请求：路径&#x2F;order&#x2F;update</p>
<p><img src="/images/image-20210716102532554.png" alt="image-20210716102532554"></p>
<p>5）总结</p>
<p>使用关联模式需满足的条件：</p>
<ul>
<li>两个有竞争关系的资源</li>
<li>一个优先级较高，一个优先级较低</li>
</ul>
<h4 id="2-2-2、链路模式"><a href="#2-2-2、链路模式" class="headerlink" title="2.2.2、链路模式"></a>2.2.2、链路模式</h4><p><strong>链路模式</strong>：只针对从指定链路访问到本资源的请求做统计，判断是否超过阈值。</p>
<p><strong>配置示例</strong>：</p>
<p>例如有两条请求链路：</p>
<ul>
<li><p>&#x2F;test1 –&gt; &#x2F;common</p>
</li>
<li><p>&#x2F;test2 –&gt; &#x2F;common</p>
</li>
</ul>
<p>如果只希望统计从&#x2F;test2 进入到&#x2F;common 的请求，则可以这样配置：</p>
<p><img src="/images/image-20210716103536346.png" alt="image-20210716103536346"></p>
<p><strong>实战案例</strong></p>
<p>需求：有查询订单和创建订单业务，两者都需要查询商品。针对从查询订单进入到查询商品的请求统计，并设置限流。</p>
<p>步骤：</p>
<ol>
<li><p>在 OrderService 中添加一个 queryGoods 方法，不用实现业务</p>
</li>
<li><p>在 OrderController 中，改造&#x2F;order&#x2F;query 端点，调用 OrderService 中的 queryGoods 方法</p>
</li>
<li><p>在 OrderController 中添加一个&#x2F;order&#x2F;save 的端点，调用 OrderService 的 queryGoods 方法</p>
</li>
<li><p>给 queryGoods 设置限流规则，从&#x2F;order&#x2F;query 进入 queryGoods 的方法限制 QPS 必须小于 2</p>
</li>
</ol>
<p>实现：</p>
<p>1）添加查询商品方法</p>
<p>在 order-service 服务中，给 OrderService 类添加一个 queryGoods 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">queryGoods</span><span class="params">()</span>&#123;</span><br><span class="line">    System.err.println(<span class="string">&quot;查询商品&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2）查询订单时，查询商品</p>
<p>在 order-service 的 OrderController 中，修改&#x2F;order&#x2F;query 端点的业务逻辑：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/query&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">queryOrder</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 查询商品</span></span><br><span class="line">    orderService.queryGoods();</span><br><span class="line">    <span class="comment">// 查询订单</span></span><br><span class="line">    System.out.println(<span class="string">&quot;查询订单&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;查询订单成功&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3）新增订单，查询商品</p>
<p>在 order-service 的 OrderController 中，修改&#x2F;order&#x2F;save 端点，模拟新增订单：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/save&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">saveOrder</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 查询商品</span></span><br><span class="line">    orderService.queryGoods();</span><br><span class="line">    <span class="comment">// 查询订单</span></span><br><span class="line">    System.err.println(<span class="string">&quot;新增订单&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;新增订单成功&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4）给查询商品添加资源标记</p>
<p>默认情况下，OrderService 中的方法是不被 Sentinel 监控的，需要我们自己通过注解来标记要监控的方法。</p>
<p>给 OrderService 的 queryGoods 方法添加@SentinelResource 注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SentinelResource(&quot;goods&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">queryGoods</span><span class="params">()</span>&#123;</span><br><span class="line">    System.err.println(<span class="string">&quot;查询商品&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>链路模式中，是对不同来源的两个链路做监控。但是 sentinel 默认会给进入 SpringMVC 的所有请求设置同一个 root 资源，会导致链路模式失效。</p>
<p>我们需要关闭这种对 SpringMVC 的资源聚合，修改 order-service 服务的 application.yml 文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">web-context-unify:</span> <span class="literal">false</span> <span class="comment"># 关闭context整合</span></span><br></pre></td></tr></table></figure>

<p>重启服务并访问&#x2F;order&#x2F;query 和&#x2F;order&#x2F;save，可查看到 sentinel 的簇点链路规则中，出现新的资源：</p>
<p><img src="/images/image-20210716105227163.png" alt="image-20210716105227163"></p>
<p>5）添加流控规则</p>
<p>点击 goods 资源的流控按钮，在弹出的表单中填写下面信息：只统计从&#x2F;order&#x2F;query 进入&#x2F;goods 的资源，QPS 阈值为 2，超出则被限流。</p>
<p><img src="/images/image-20210716105408723.png" alt="image-20210716105408723"></p>
<p>6）Jmeter 测试</p>
<p>选择《流控模式-链路》：50 秒内 200 个线程，即 QPS 为 4，超过设定的阈值 2</p>
<p><img src="/images/image-20210716105612312.png" alt="image-20210716105612312"></p>
<p>一个 http 请求是访问&#x2F;order&#x2F;save：</p>
<p><img src="/images/image-20210716105812789.png" alt="image-20210716105812789"></p>
<p>运行的结果：完全不受影响。</p>
<p><img src="/images/image-20210716110027064.png" alt="image-20210716110027064"></p>
<p>另一个是访问&#x2F;order&#x2F;query：</p>
<p><img src="/images/image-20210716105855951.png" alt="image-20210716105855951"></p>
<p>运行结果：每次只有 2 个通过。</p>
<p><img src="/images/image-20210716105956401.png" alt="image-20210716105956401"></p>
<h4 id="2-2-3-总结"><a href="#2-2-3-总结" class="headerlink" title="2.2.3.总结"></a>2.2.3.总结</h4><p>流控模式有哪些？</p>
<ul>
<li><p>直接：对当前资源限流</p>
</li>
<li><p>关联：高优先级资源触发阈值，对低优先级资源限流。</p>
</li>
<li><p>链路：阈值统计时，只统计从指定资源进入当前资源的请求，是对请求来源的限流</p>
</li>
</ul>
<h3 id="2-3、流控效果"><a href="#2-3、流控效果" class="headerlink" title="2.3、流控效果"></a>2.3、流控效果</h3><p>在流控的高级选项中有流控效果选项：</p>
<p><img src="/images/image-20210716110225104.png" alt="image-20210716110225104"></p>
<p>流控效果是指请求达到流控阈值时应该采取的措施，包括三种：</p>
<ul>
<li><p>快速失败：达到阈值后，新的请求会被立即拒绝并抛出 FlowException 异常。是默认的处理方式。</p>
</li>
<li><p>warm up：预热模式，对超出阈值的请求同样是拒绝并抛出异常。但这种模式阈值会动态变化，从一个较小值逐渐增加到最大阈值。</p>
</li>
<li><p>排队等待：让所有的请求按照先后次序排队执行，两个请求的间隔不能小于指定时长</p>
</li>
</ul>
<h4 id="2-3-1、warm-up"><a href="#2-3-1、warm-up" class="headerlink" title="2.3.1、warm up"></a>2.3.1、warm up</h4><p>阈值一般是一个微服务能承担的最大 QPS，但是一个服务刚刚启动时，一切资源尚未初始化（<strong>冷启动</strong>），如果直接将 QPS 跑到最大值，可能导致服务瞬间宕机。</p>
<p>warm up 也叫<strong>预热模式</strong>，是应对服务冷启动的一种方案。请求阈值初始值是 maxThreshold &#x2F; coldFactor，持续指定时长后，逐渐提高到 maxThreshold 值。而 coldFactor 的默认值是 3.</p>
<p>例如，设置 QPS 的 maxThreshold 为 10，预热时间为 5 秒，那么初始阈值就是 10 &#x2F; 3 ，也就是 3，然后在 5 秒后逐渐增长到 10.</p>
<p><img src="/images/image-20210716110629796.png" alt="image-20210716110629796"></p>
<h5 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h5><p>需求：给&#x2F;order&#x2F;{orderId}这个资源设置限流，最大 QPS 为 10，利用 warm up 效果，预热时长为 5 秒</p>
<p>1）配置流控规则：</p>
<p><img src="/images/image-20210716111012387.png" alt="image-20210716111012387"></p>
<p>2）Jmeter 测试</p>
<p>选择《流控效果，warm up》：QPS 为 10.</p>
<p><img src="/images/image-20210716111136699.png" alt="image-20210716111136699"></p>
<p>刚刚启动时，大部分请求失败，成功的只有 3 个，说明 QPS 被限定在 3：</p>
<p><img src="/images/image-20210716111303701.png" alt="image-20210716111303701"></p>
<p>随着时间推移，成功比例越来越高：</p>
<p><img src="/images/image-20210716111404717.png" alt="image-20210716111404717"></p>
<p>在 Sentinel 控制台查看实时监控：</p>
<p><img src="/images/image-20210716111526480.png" alt="image-20210716111526480"></p>
<p>一段时间后：</p>
<p><img src="/images/image-20210716111658541.png" alt="image-20210716111658541"></p>
<h4 id="2-3-2、排队等待"><a href="#2-3-2、排队等待" class="headerlink" title="2.3.2、排队等待"></a>2.3.2、排队等待</h4><p>当请求超过 QPS 阈值时，快速失败和 warm up 会拒绝新的请求并抛出异常。</p>
<p>而排队等待则是让所有请求进入一个队列中，然后按照阈值允许的时间间隔依次执行。后来的请求必须等待前面执行完成，如果请求预期的等待时间超出最大时长，则会被拒绝。</p>
<p>工作原理</p>
<p>例如：QPS &#x3D; 5，意味着每 200ms 处理一个队列中的请求；timeout &#x3D; 2000，意味着<strong>预期等待时长</strong>超过 2000ms 的请求会被拒绝并抛出异常。</p>
<p>那什么叫做预期等待时长呢？</p>
<p>比如现在一下子来了 12 个请求，因为每 200ms 执行一个请求，那么：</p>
<ul>
<li>第 6 个请求的<strong>预期等待时长</strong> &#x3D; 200 * （6 - 1） &#x3D; 1000ms</li>
<li>第 12 个请求的预期等待时长 &#x3D; 200 * （12-1） &#x3D; 2200ms</li>
</ul>
<p>现在，第 1 秒同时接收到 10 个请求，但第 2 秒只有 1 个请求，此时 QPS 的曲线这样的：</p>
<p><img src="/images/image-20210716113147176.png" alt="image-20210716113147176"></p>
<p>如果使用队列模式做流控，所有进入的请求都要排队，以固定的 200ms 的间隔执行，QPS 会变的很平滑：</p>
<p><img src="/images/image-20210716113426524.png" alt="image-20210716113426524"></p>
<p>平滑的 QPS 曲线，对于服务器来说是更友好的。</p>
<h5 id="案例-1"><a href="#案例-1" class="headerlink" title="案例"></a>案例</h5><p>需求：给&#x2F;order&#x2F;{orderId}这个资源设置限流，最大 QPS 为 10，利用排队的流控效果，超时时长设置为 5s</p>
<p>1）添加流控规则</p>
<p><img src="/images/image-20210716114048918.png" alt="image-20210716114048918"></p>
<p>2）Jmeter 测试</p>
<p>选择《流控效果，队列》：QPS 为 15，超过设定的 10。</p>
<p><img src="/images/image-20210716114243558.png" alt="image-20210716114243558"></p>
<p>如果是之前的 快速失败、warmup 模式，超出的请求应该会直接报错。</p>
<p>但是看看队列模式的运行结果：全部都通过</p>
<p><img src="/images/image-20210716114429361.png" alt="image-20210716114429361"></p>
<p>在 sentinel 查看实时监控的 QPS 曲线：</p>
<p><img src="/images/image-20210716114522935.png" alt="image-20210716114522935"></p>
<p>QPS 非常平滑，一致保持在 10，但是超出的请求没有被拒绝，而是放入队列。因此<strong>响应时间</strong>（等待时间）会越来越长。</p>
<p>当队列满了以后，才会有部分请求失败：</p>
<p><img src="/images/image-20210716114651137.png" alt="image-20210716114651137"></p>
<h4 id="2-3-3"><a href="#2-3-3" class="headerlink" title="2.3.3"></a>2.3.3</h4><h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>流控效果有哪些？</p>
<ul>
<li><p>快速失败：QPS 超过阈值时，拒绝新的请求</p>
</li>
<li><p>warm up： QPS 超过阈值时，拒绝新的请求；QPS 阈值是逐渐提升的，可以避免冷启动时高并发导致服务宕机。</p>
</li>
<li><p>排队等待：请求会进入队列，按照阈值允许的时间间隔依次执行请求；如果请求预期等待时长大于超时时间，直接拒绝</p>
</li>
</ul>
<h3 id="2-4、热点参数限流"><a href="#2-4、热点参数限流" class="headerlink" title="2.4、热点参数限流"></a>2.4、热点参数限流</h3><p>之前的限流是统计访问某个资源的所有请求，判断是否超过 QPS 阈值。而热点参数限流是<strong>分别统计参数值相同的请求</strong>，判断是否超过 QPS 阈值。</p>
<h5 id="2-4-1、全局参数限流"><a href="#2-4-1、全局参数限流" class="headerlink" title="2.4.1、全局参数限流"></a>2.4.1、全局参数限流</h5><p>例如，一个根据 id 查询商品的接口：</p>
<p><img src="/images/image-20210716115014663.png" alt="image-20210716115014663"></p>
<p>访问&#x2F;goods&#x2F;{id}的请求中，id 参数值会有变化，热点参数限流会根据参数值分别统计 QPS，统计结果：</p>
<p><img src="/images/image-20210716115131463.png" alt="image-20210716115131463"></p>
<p>当 id&#x3D;1 的请求触发阈值被限流时，id 值不为 1 的请求不受影响。</p>
<p>配置示例：</p>
<p><img src="D:/BaiDuDisk/BaiduNetdiskDownload/学习资料/day01-微服务保护/讲义/assets/image-20210716115232426.png" alt="image-20210716115232426"></p>
<p>代表的含义是：对 hot 这个资源的 0 号参数（第一个参数）做统计，每 1 秒<strong>相同参数值</strong>的请求数不能超过 5</p>
<h5 id="2-4-2、热点参数限流"><a href="#2-4-2、热点参数限流" class="headerlink" title="2.4.2、热点参数限流"></a>2.4.2、热点参数限流</h5><p>刚才的配置中，对查询商品这个接口的所有商品一视同仁，QPS 都限定为 5.</p>
<p>而在实际开发中，可能部分商品是热点商品，例如秒杀商品，我们希望这部分商品的 QPS 限制与其它商品不一样，高一些。那就需要配置热点参数限流的高级选项了：</p>
<p><img src="D:/BaiDuDisk/BaiduNetdiskDownload/学习资料/day01-微服务保护/讲义/assets/image-20210716115717523.png" alt="image-20210716115717523"></p>
<p>结合上一个配置，这里的含义是对 0 号的 long 类型参数限流，每 1 秒相同参数的 QPS 不能超过 5，有两个例外：</p>
<p>•如果参数值是 100，则每 1 秒允许的 QPS 为 10</p>
<p>•如果参数值是 101，则每 1 秒允许的 QPS 为 15</p>
<h5 id="2-4-3、案例"><a href="#2-4-3、案例" class="headerlink" title="2.4.3、案例"></a>2.4.3、案例</h5><p><strong>案例需求</strong>：给&#x2F;order&#x2F;{orderId}这个资源添加热点参数限流，规则如下：</p>
<ul>
<li><p>默认的热点参数规则是每 1 秒请求量不超过 2</p>
</li>
<li><p>给 102 这个参数设置例外：每 1 秒请求量不超过 4</p>
</li>
<li><p>给 103 这个参数设置例外：每 1 秒请求量不超过 10</p>
</li>
</ul>
<p><strong>注意事项</strong>：热点参数限流对默认的 SpringMVC 资源无效，需要利用@SentinelResource 注解标记资源</p>
<p>1）标记资源</p>
<p>给 order-service 中的 OrderController 中的&#x2F;order&#x2F;{orderId}资源添加注解：</p>
<p><img src="D:/BaiDuDisk/BaiduNetdiskDownload/学习资料/day01-微服务保护/讲义/assets/image-20210716120033572.png" alt="image-20210716120033572"></p>
<p>2）热点参数限流规则</p>
<p>访问该接口，可以看到我们标记的 hot 资源出现了：</p>
<p><img src="D:/BaiDuDisk/BaiduNetdiskDownload/学习资料/day01-微服务保护/讲义/assets/image-20210716120208509.png" alt="image-20210716120208509"></p>
<p>这里不要点击 hot 后面的按钮，页面有 BUG</p>
<p>点击左侧菜单中<strong>热点规则</strong>菜单：</p>
<p><img src="D:/BaiDuDisk/BaiduNetdiskDownload/学习资料/day01-微服务保护/讲义/assets/image-20210716120319009.png" alt="image-20210716120319009"></p>
<p>点击新增，填写表单：</p>
<p><img src="D:/BaiDuDisk/BaiduNetdiskDownload/学习资料/day01-微服务保护/讲义/assets/image-20210716120536714.png" alt="image-20210716120536714"></p>
<p>3）Jmeter 测试</p>
<p>选择《热点参数限流 QPS1》：</p>
<p><img src="D:/BaiDuDisk/BaiduNetdiskDownload/学习资料/day01-微服务保护/讲义/assets/image-20210716120754527.png" alt="image-20210716120754527"></p>
<p>这里发起请求的 QPS 为 5.</p>
<p>包含 3 个 http 请求：</p>
<p>普通参数，QPS 阈值为 2</p>
<p><img src="D:/BaiDuDisk/BaiduNetdiskDownload/学习资料/day01-微服务保护/讲义/assets/image-20210716120840501.png" alt="image-20210716120840501"></p>
<p>运行结果：</p>
<p><img src="D:/BaiDuDisk/BaiduNetdiskDownload/学习资料/day01-微服务保护/讲义/assets/image-20210716121105567.png" alt="image-20210716121105567"></p>
<p>例外项，QPS 阈值为 4</p>
<p><img src="D:/BaiDuDisk/BaiduNetdiskDownload/学习资料/day01-微服务保护/讲义/assets/image-20210716120900365.png" alt="image-20210716120900365"></p>
<p>运行结果：</p>
<p><img src="D:/BaiDuDisk/BaiduNetdiskDownload/学习资料/day01-微服务保护/讲义/assets/image-20210716121201630.png" alt="image-20210716121201630"></p>
<p>例外项，QPS 阈值为 10</p>
<p><img src="D:/BaiDuDisk/BaiduNetdiskDownload/学习资料/day01-微服务保护/讲义/assets/image-20210716120919131.png" alt="image-20210716120919131"></p>
<p>运行结果：</p>
<p><img src="D:/BaiDuDisk/BaiduNetdiskDownload/学习资料/day01-微服务保护/讲义/assets/image-20210716121220305.png" alt="image-20210716121220305"></p>
<h1 id="3-隔离和降级"><a href="#3-隔离和降级" class="headerlink" title="3.隔离和降级"></a>3.隔离和降级</h1><p>限流是一种预防措施，虽然限流可以尽量避免因高并发而引起的服务故障，但服务还会因为其它原因而故障。</p>
<p>而要将这些故障控制在一定范围，避免雪崩，就要靠<strong>线程隔离</strong>（舱壁模式）和<strong>熔断降级</strong>手段了。</p>
<p><strong>线程隔离</strong>之前讲到过：调用者在调用服务提供者时，给每个调用的请求分配独立线程池，出现故障时，最多消耗这个线程池内资源，避免把调用者的所有资源耗尽。</p>
<p><img src="D:/BaiDuDisk/BaiduNetdiskDownload/学习资料/day01-微服务保护/讲义/assets/image-20210715173215243.png" alt="image-20210715173215243"></p>
<p><strong>熔断降级</strong>：是在调用方这边加入断路器，统计对服务提供者的调用，如果调用的失败比例过高，则熔断该业务，不允许访问该服务的提供者了。</p>
<p><img src="D:/BaiDuDisk/BaiduNetdiskDownload/学习资料/day01-微服务保护/讲义/assets/image-20210715173428073.png" alt="image-20210715173428073"></p>
<p>可以看到，不管是线程隔离还是熔断降级，都是对<strong>客户端</strong>（调用方）的保护。需要在<strong>调用方</strong> 发起远程调用时做线程隔离、或者服务熔断。</p>
<p>而我们的微服务远程调用都是基于 Feign 来完成的，因此我们需要将 Feign 与 Sentinel 整合，在 Feign 里面实现线程隔离和服务熔断。</p>
<h2 id="3-1-FeignClient-整合-Sentinel"><a href="#3-1-FeignClient-整合-Sentinel" class="headerlink" title="3.1.FeignClient 整合 Sentinel"></a>3.1.FeignClient 整合 Sentinel</h2><p>SpringCloud 中，微服务调用都是通过 Feign 来实现的，因此做客户端保护必须整合 Feign 和 Sentinel。</p>
<h3 id="3-1-1-修改配置，开启-sentinel-功能"><a href="#3-1-1-修改配置，开启-sentinel-功能" class="headerlink" title="3.1.1.修改配置，开启 sentinel 功能"></a>3.1.1.修改配置，开启 sentinel 功能</h3><p>修改 OrderService 的 application.yml 文件，开启 Feign 的 Sentinel 功能：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">sentinel:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 开启feign对sentinel的支持</span></span><br></pre></td></tr></table></figure>

<h3 id="3-1-2-编写失败降级逻辑"><a href="#3-1-2-编写失败降级逻辑" class="headerlink" title="3.1.2.编写失败降级逻辑"></a>3.1.2.编写失败降级逻辑</h3><p>业务失败后，不能直接报错，而应该返回用户一个友好提示或者默认结果，这个就是失败降级逻辑。</p>
<p>给 FeignClient 编写失败后的降级逻辑</p>
<p>① 方式一：FallbackClass，无法对远程调用的异常做处理</p>
<p>② 方式二：FallbackFactory，可以对远程调用的异常做处理，我们选择这种</p>
<p>这里我们演示方式二的失败降级处理。</p>
<p><strong>步骤一</strong>：在 feing-api 项目中定义类，实现 FallbackFactory：</p>
<p><img src="D:/BaiDuDisk/BaiduNetdiskDownload/学习资料/day01-微服务保护/讲义/assets/image-20210716122403502.png" alt="image-20210716122403502"></p>
<p>代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.itcast.feign.clients.fallback;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.itcast.feign.clients.UserClient;</span><br><span class="line"><span class="keyword">import</span> cn.itcast.feign.pojo.User;</span><br><span class="line"><span class="keyword">import</span> feign.hystrix.FallbackFactory;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserClientFallbackFactory</span> <span class="keyword">implements</span> <span class="title class_">FallbackFactory</span>&lt;UserClient&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserClient <span class="title function_">create</span><span class="params">(Throwable throwable)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">UserClient</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> User <span class="title function_">findById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">                log.error(<span class="string">&quot;查询用户异常&quot;</span>, throwable);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>步骤二</strong>：在 feing-api 项目中的 DefaultFeignConfiguration 类中将 UserClientFallbackFactory 注册为一个 Bean：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> UserClientFallbackFactory <span class="title function_">userClientFallbackFactory</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">UserClientFallbackFactory</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>步骤三</strong>：在 feing-api 项目中的 UserClient 接口中使用 UserClientFallbackFactory：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cn.itcast.feign.clients.fallback.UserClientFallbackFactory;</span><br><span class="line"><span class="keyword">import</span> cn.itcast.feign.pojo.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.FeignClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;userservice&quot;, fallbackFactory = UserClientFallbackFactory.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/user/&#123;id&#125;&quot;)</span></span><br><span class="line">    User <span class="title function_">findById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重启后，访问一次订单查询业务，然后查看 sentinel 控制台，可以看到新的簇点链路：</p>
<p><img src="D:/BaiDuDisk/BaiduNetdiskDownload/学习资料/day01-微服务保护/讲义/assets/image-20210716123705780.png" alt="image-20210716123705780"></p>
<h3 id="3-1-3-总结"><a href="#3-1-3-总结" class="headerlink" title="3.1.3.总结"></a>3.1.3.总结</h3><p>Sentinel 支持的雪崩解决方案：</p>
<ul>
<li>线程隔离（仓壁模式）</li>
<li>降级熔断</li>
</ul>
<p>Feign 整合 Sentinel 的步骤：</p>
<ul>
<li>在 application.yml 中配置：feign.sentienl.enable&#x3D;true</li>
<li>给 FeignClient 编写 FallbackFactory 并注册为 Bean</li>
<li>将 FallbackFactory 配置到 FeignClient</li>
</ul>
<h2 id="3-2-线程隔离（舱壁模式）"><a href="#3-2-线程隔离（舱壁模式）" class="headerlink" title="3.2.线程隔离（舱壁模式）"></a>3.2.线程隔离（舱壁模式）</h2><h3 id="3-2-1-线程隔离的实现方式"><a href="#3-2-1-线程隔离的实现方式" class="headerlink" title="3.2.1.线程隔离的实现方式"></a>3.2.1.线程隔离的实现方式</h3><p>线程隔离有两种方式实现：</p>
<ul>
<li><p>线程池隔离</p>
</li>
<li><p>信号量隔离（Sentinel 默认采用）</p>
</li>
</ul>
<p>如图：</p>
<p><img src="D:/BaiDuDisk/BaiduNetdiskDownload/学习资料/day01-微服务保护/讲义/assets/image-20210716123036937.png" alt="image-20210716123036937"></p>
<p><strong>线程池隔离</strong>：给每个服务调用业务分配一个线程池，利用线程池本身实现隔离效果</p>
<p><strong>信号量隔离</strong>：不创建线程池，而是计数器模式，记录业务使用的线程数量，达到信号量上限时，禁止新的请求。</p>
<p>两者的优缺点：</p>
<p><img src="D:/BaiDuDisk/BaiduNetdiskDownload/学习资料/day01-微服务保护/讲义/assets/image-20210716123240518.png" alt="image-20210716123240518"></p>
<h3 id="3-2-2-sentinel-的线程隔离"><a href="#3-2-2-sentinel-的线程隔离" class="headerlink" title="3.2.2.sentinel 的线程隔离"></a>3.2.2.sentinel 的线程隔离</h3><p><strong>用法说明</strong>：</p>
<p>在添加限流规则时，可以选择两种阈值类型：</p>
<p><img src="D:/BaiDuDisk/BaiduNetdiskDownload/学习资料/day01-微服务保护/讲义/assets/image-20210716123411217.png" alt="image-20210716123411217"></p>
<ul>
<li><p>QPS：就是每秒的请求数，在快速入门中已经演示过</p>
</li>
<li><p>线程数：是该资源能使用用的 tomcat 线程数的最大值。也就是通过限制线程数量，实现<strong>线程隔离</strong>（舱壁模式）。</p>
</li>
</ul>
<p><strong>案例需求</strong>：给 order-service 服务中的 UserClient 的查询用户接口设置流控规则，线程数不能超过 2。然后利用 jemeter 测试。</p>
<h4 id="1）配置隔离规则"><a href="#1）配置隔离规则" class="headerlink" title="1）配置隔离规则"></a>1）配置隔离规则</h4><p>选择 feign 接口后面的流控按钮：</p>
<p><img src="D:/BaiDuDisk/BaiduNetdiskDownload/学习资料/day01-微服务保护/讲义/assets/image-20210716123831992.png" alt="image-20210716123831992"></p>
<p>填写表单：</p>
<p><img src="D:/BaiDuDisk/BaiduNetdiskDownload/学习资料/day01-微服务保护/讲义/assets/image-20210716123936844.png" alt="image-20210716123936844"></p>
<h4 id="2）Jmeter-测试"><a href="#2）Jmeter-测试" class="headerlink" title="2）Jmeter 测试"></a>2）Jmeter 测试</h4><p>选择《阈值类型-线程数&lt;2》：</p>
<p><img src="D:/BaiDuDisk/BaiduNetdiskDownload/学习资料/day01-微服务保护/讲义/assets/image-20210716124229894.png" alt="image-20210716124229894"></p>
<p>一次发生 10 个请求，有较大概率并发线程数超过 2，而超出的请求会走之前定义的失败降级逻辑。</p>
<p>查看运行结果：</p>
<p><img src="D:/BaiDuDisk/BaiduNetdiskDownload/学习资料/day01-微服务保护/讲义/assets/image-20210716124147820.png" alt="image-20210716124147820"></p>
<p>发现虽然结果都是通过了，不过部分请求得到的响应是降级返回的 null 信息。</p>
<h3 id="3-2-3-总结"><a href="#3-2-3-总结" class="headerlink" title="3.2.3.总结"></a>3.2.3.总结</h3><p>线程隔离的两种手段是？</p>
<ul>
<li><p>信号量隔离</p>
</li>
<li><p>线程池隔离</p>
</li>
</ul>
<p>信号量隔离的特点是？</p>
<ul>
<li>基于计数器模式，简单，开销小</li>
</ul>
<p>线程池隔离的特点是？</p>
<ul>
<li>基于线程池模式，有额外开销，但隔离控制更强</li>
</ul>
<h2 id="3-3-熔断降级"><a href="#3-3-熔断降级" class="headerlink" title="3.3.熔断降级"></a>3.3.熔断降级</h2><p>熔断降级是解决雪崩问题的重要手段。其思路是由<strong>断路器</strong>统计服务调用的异常比例、慢请求比例，如果超出阈值则会<strong>熔断</strong>该服务。即拦截访问该服务的一切请求；而当服务恢复时，断路器会放行访问该服务的请求。</p>
<p>断路器控制熔断和放行是通过状态机来完成的：</p>
<p><img src="D:/BaiDuDisk/BaiduNetdiskDownload/学习资料/day01-微服务保护/讲义/assets/image-20210716130958518.png" alt="image-20210716130958518"></p>
<p>状态机包括三个状态：</p>
<ul>
<li>closed：关闭状态，断路器放行所有请求，并开始统计异常比例、慢请求比例。超过阈值则切换到 open 状态</li>
<li>open：打开状态，服务调用被<strong>熔断</strong>，访问被熔断服务的请求会被拒绝，快速失败，直接走降级逻辑。Open 状态 5 秒后会进入 half-open 状态</li>
<li>half-open：半开状态，放行一次请求，根据执行结果来判断接下来的操作。<ul>
<li>请求成功：则切换到 closed 状态</li>
<li>请求失败：则切换到 open 状态</li>
</ul>
</li>
</ul>
<p>断路器熔断策略有三种：慢调用、异常比例、异常数</p>
<h3 id="3-3-1-慢调用"><a href="#3-3-1-慢调用" class="headerlink" title="3.3.1.慢调用"></a>3.3.1.慢调用</h3><p><strong>慢调用</strong>：业务的响应时长（RT）大于指定时长的请求认定为慢调用请求。在指定时间内，如果请求数量超过设定的最小数量，慢调用比例大于设定的阈值，则触发熔断。</p>
<p>例如：</p>
<p><img src="D:/BaiDuDisk/BaiduNetdiskDownload/学习资料/day01-微服务保护/讲义/assets/image-20210716145934347.png" alt="image-20210716145934347"></p>
<p>解读：RT 超过 500ms 的调用是慢调用，统计最近 10000ms 内的请求，如果请求量超过 10 次，并且慢调用比例不低于 0.5，则触发熔断，熔断时长为 5 秒。然后进入 half-open 状态，放行一次请求做测试。</p>
<p><strong>案例</strong></p>
<p>需求：给 UserClient 的查询用户接口设置降级规则，慢调用的 RT 阈值为 50ms，统计时间为 1 秒，最小请求数量为 5，失败阈值比例为 0.4，熔断时长为 5</p>
<h4 id="1）设置慢调用"><a href="#1）设置慢调用" class="headerlink" title="1）设置慢调用"></a>1）设置慢调用</h4><p>修改 user-service 中的&#x2F;user&#x2F;{id}这个接口的业务。通过休眠模拟一个延迟时间：</p>
<p><img src="D:/BaiDuDisk/BaiduNetdiskDownload/学习资料/day01-微服务保护/讲义/assets/image-20210716150234787.png" alt="image-20210716150234787"></p>
<p>此时，orderId&#x3D;101 的订单，关联的是 id 为 1 的用户，调用时长为 60ms：</p>
<p><img src="D:/BaiDuDisk/BaiduNetdiskDownload/学习资料/day01-微服务保护/讲义/assets/image-20210716150510956.png" alt="image-20210716150510956"></p>
<p>orderId&#x3D;102 的订单，关联的是 id 为 2 的用户，调用时长为非常短；</p>
<p><img src="D:/BaiDuDisk/BaiduNetdiskDownload/学习资料/day01-微服务保护/讲义/assets/image-20210716150605208.png" alt="image-20210716150605208"></p>
<h4 id="2）设置熔断规则"><a href="#2）设置熔断规则" class="headerlink" title="2）设置熔断规则"></a>2）设置熔断规则</h4><p>下面，给 feign 接口设置降级规则：</p>
<p><img src="D:/BaiDuDisk/BaiduNetdiskDownload/学习资料/day01-微服务保护/讲义/assets/image-20210716150654094.png" alt="image-20210716150654094"></p>
<p>规则：</p>
<p><img src="D:/BaiDuDisk/BaiduNetdiskDownload/学习资料/day01-微服务保护/讲义/assets/image-20210716150740434.png" alt="image-20210716150740434"></p>
<p>超过 50ms 的请求都会被认为是慢请求</p>
<h4 id="3）测试"><a href="#3）测试" class="headerlink" title="3）测试"></a>3）测试</h4><p>在浏览器访问：<a target="_blank" rel="noopener" href="http://localhost:8088/order/101%EF%BC%8C%E5%BF%AB%E9%80%9F%E5%88%B7%E6%96%B0">http://localhost:8088/order/101，快速刷新</a> 5 次，可以发现：</p>
<p><img src="D:/BaiDuDisk/BaiduNetdiskDownload/学习资料/day01-微服务保护/讲义/assets/image-20210716150911004.png" alt="image-20210716150911004"></p>
<p>触发了熔断，请求时长缩短至 5ms，快速失败了，并且走降级逻辑，返回的 null</p>
<p>在浏览器访问：<a target="_blank" rel="noopener" href="http://localhost:8088/order/102%EF%BC%8C%E7%AB%9F%E7%84%B6%E4%B9%9F%E8%A2%AB%E7%86%94%E6%96%AD%E4%BA%86%EF%BC%9A">http://localhost:8088/order/102，竟然也被熔断了：</a></p>
<p><img src="D:/BaiDuDisk/BaiduNetdiskDownload/学习资料/day01-微服务保护/讲义/assets/image-20210716151107785.png" alt="image-20210716151107785"></p>
<h3 id="3-3-2-异常比例、异常数"><a href="#3-3-2-异常比例、异常数" class="headerlink" title="3.3.2.异常比例、异常数"></a>3.3.2.异常比例、异常数</h3><p><strong>异常比例或异常数</strong>：统计指定时间内的调用，如果调用次数超过指定请求数，并且出现异常的比例达到设定的比例阈值（或超过指定异常数），则触发熔断。</p>
<p>例如，一个异常比例设置：</p>
<p><img src="D:/BaiDuDisk/BaiduNetdiskDownload/学习资料/day01-微服务保护/讲义/assets/image-20210716131430682.png" alt="image-20210716131430682"></p>
<p>解读：统计最近 1000ms 内的请求，如果请求量超过 10 次，并且异常比例不低于 0.4，则触发熔断。</p>
<p>一个异常数设置：</p>
<p><img src="D:/BaiDuDisk/BaiduNetdiskDownload/学习资料/day01-微服务保护/讲义/assets/image-20210716131522912.png" alt="image-20210716131522912"></p>
<p>解读：统计最近 1000ms 内的请求，如果请求量超过 10 次，并且异常比例不低于 2 次，则触发熔断。</p>
<p><strong>案例</strong></p>
<p>需求：给 UserClient 的查询用户接口设置降级规则，统计时间为 1 秒，最小请求数量为 5，失败阈值比例为 0.4，熔断时长为 5s</p>
<h4 id="1）设置异常请求"><a href="#1）设置异常请求" class="headerlink" title="1）设置异常请求"></a>1）设置异常请求</h4><p>首先，修改 user-service 中的&#x2F;user&#x2F;{id}这个接口的业务。手动抛出异常，以触发异常比例的熔断：</p>
<p><img src="D:/BaiDuDisk/BaiduNetdiskDownload/学习资料/day01-微服务保护/讲义/assets/image-20210716151348183.png" alt="image-20210716151348183"></p>
<p>也就是说，id 为 2 时，就会触发异常</p>
<h4 id="2）设置熔断规则-1"><a href="#2）设置熔断规则-1" class="headerlink" title="2）设置熔断规则"></a>2）设置熔断规则</h4><p>下面，给 feign 接口设置降级规则：</p>
<p><img src="D:/BaiDuDisk/BaiduNetdiskDownload/学习资料/day01-微服务保护/讲义/assets/image-20210716150654094.png" alt="image-20210716150654094"></p>
<p>规则：</p>
<p><img src="D:/BaiDuDisk/BaiduNetdiskDownload/学习资料/day01-微服务保护/讲义/assets/image-20210716151538785.png" alt="image-20210716151538785"></p>
<p>在 5 次请求中，只要异常比例超过 0.4，也就是有 2 次以上的异常，就会触发熔断。</p>
<h4 id="3）测试-1"><a href="#3）测试-1" class="headerlink" title="3）测试"></a>3）测试</h4><p>在浏览器快速访问：<a target="_blank" rel="noopener" href="http://localhost:8088/order/102%EF%BC%8C%E5%BF%AB%E9%80%9F%E5%88%B7%E6%96%B0">http://localhost:8088/order/102，快速刷新</a> 5 次，触发熔断：</p>
<p><img src="D:/BaiDuDisk/BaiduNetdiskDownload/学习资料/day01-微服务保护/讲义/assets/image-20210716151722916.png" alt="image-20210716151722916"></p>
<p>此时，我们去访问本来应该正常的 103：</p>
<p><img src="D:/BaiDuDisk/BaiduNetdiskDownload/学习资料/day01-微服务保护/讲义/assets/image-20210716151844817.png" alt="image-20210716151844817"></p>
<h1 id="4-授权规则"><a href="#4-授权规则" class="headerlink" title="4.授权规则"></a>4.授权规则</h1><p>授权规则可以对请求方来源做判断和控制。</p>
<h2 id="4-1-授权规则"><a href="#4-1-授权规则" class="headerlink" title="4.1.授权规则"></a>4.1.授权规则</h2><h3 id="4-1-1-基本规则"><a href="#4-1-1-基本规则" class="headerlink" title="4.1.1.基本规则"></a>4.1.1.基本规则</h3><p>授权规则可以对调用方的来源做控制，有白名单和黑名单两种方式。</p>
<ul>
<li><p>白名单：来源（origin）在白名单内的调用者允许访问</p>
</li>
<li><p>黑名单：来源（origin）在黑名单内的调用者不允许访问</p>
</li>
</ul>
<p>点击左侧菜单的授权，可以看到授权规则：</p>
<p><img src="D:/BaiDuDisk/BaiduNetdiskDownload/学习资料/day01-微服务保护/讲义/assets/image-20210716152010750.png" alt="image-20210716152010750"></p>
<ul>
<li><p>资源名：就是受保护的资源，例如&#x2F;order&#x2F;{orderId}</p>
</li>
<li><p>流控应用：是来源者的名单，</p>
<ul>
<li>如果是勾选白名单，则名单中的来源被许可访问。</li>
<li>如果是勾选黑名单，则名单中的来源被禁止访问。</li>
</ul>
</li>
</ul>
<p>比如：</p>
<p><img src="D:/BaiDuDisk/BaiduNetdiskDownload/学习资料/day01-微服务保护/讲义/assets/image-20210716152349191.png" alt="image-20210716152349191"></p>
<p>我们允许请求从 gateway 到 order-service，不允许浏览器访问 order-service，那么白名单中就要填写<strong>网关的来源名称（origin）</strong>。</p>
<h3 id="4-1-2-如何获取-origin"><a href="#4-1-2-如何获取-origin" class="headerlink" title="4.1.2.如何获取 origin"></a>4.1.2.如何获取 origin</h3><p>Sentinel 是通过 RequestOriginParser 这个接口的 parseOrigin 来获取请求的来源的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RequestOriginParser</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从请求request对象中获取origin，获取方式自定义</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">parseOrigin</span><span class="params">(HttpServletRequest request)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个方法的作用就是从 request 对象中，获取请求者的 origin 值并返回。</p>
<p>默认情况下，sentinel 不管请求者从哪里来，返回值永远是 default，也就是说一切请求的来源都被认为是一样的值 default。</p>
<p>因此，我们需要自定义这个接口的实现，让<strong>不同的请求，返回不同的 origin</strong>。</p>
<p>例如 order-service 服务中，我们定义一个 RequestOriginParser 的实现类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.itcast.order.sentinel;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.adapter.spring.webmvc.callback.RequestOriginParser;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HeaderOriginParser</span> <span class="keyword">implements</span> <span class="title class_">RequestOriginParser</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">parseOrigin</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">        <span class="comment">// 1.获取请求头</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">origin</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;origin&quot;</span>);</span><br><span class="line">        <span class="comment">// 2.非空判断</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(origin)) &#123;</span><br><span class="line">            origin = <span class="string">&quot;blank&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> origin;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们会尝试从 request-header 中获取 origin 值。</p>
<h3 id="4-1-3-给网关添加请求头"><a href="#4-1-3-给网关添加请求头" class="headerlink" title="4.1.3.给网关添加请求头"></a>4.1.3.给网关添加请求头</h3><p>既然获取请求 origin 的方式是从 reques-header 中获取 origin 值，我们必须让<strong>所有从 gateway 路由到微服务的请求都带上 origin 头</strong>。</p>
<p>这个需要利用之前学习的一个 GatewayFilter 来实现，AddRequestHeaderGatewayFilter。</p>
<p>修改 gateway 服务中的 application.yml，添加一个 defaultFilter：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">default-filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">AddRequestHeader=origin,gateway</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="comment"># ...略</span></span><br></pre></td></tr></table></figure>

<p>这样，从 gateway 路由的所有请求都会带上 origin 头，值为 gateway。而从其它地方到达微服务的请求则没有这个头。</p>
<h3 id="4-1-4-配置授权规则"><a href="#4-1-4-配置授权规则" class="headerlink" title="4.1.4.配置授权规则"></a>4.1.4.配置授权规则</h3><p>接下来，我们添加一个授权规则，放行 origin 值为 gateway 的请求。</p>
<p><img src="D:/BaiDuDisk/BaiduNetdiskDownload/学习资料/day01-微服务保护/讲义/assets/image-20210716153250134.png" alt="image-20210716153250134"></p>
<p>配置如下：</p>
<p><img src="D:/BaiDuDisk/BaiduNetdiskDownload/学习资料/day01-微服务保护/讲义/assets/image-20210716153301069.png" alt="image-20210716153301069"></p>
<p>现在，我们直接跳过网关，访问 order-service 服务：</p>
<p><img src="D:/BaiDuDisk/BaiduNetdiskDownload/学习资料/day01-微服务保护/讲义/assets/image-20210716153348396.png" alt="image-20210716153348396"></p>
<p>通过网关访问：</p>
<p><img src="D:/BaiDuDisk/BaiduNetdiskDownload/学习资料/day01-微服务保护/讲义/assets/image-20210716153434095.png" alt="image-20210716153434095"></p>
<h2 id="4-2-自定义异常结果"><a href="#4-2-自定义异常结果" class="headerlink" title="4.2.自定义异常结果"></a>4.2.自定义异常结果</h2><p>默认情况下，发生限流、降级、授权拦截时，都会抛出异常到调用方。异常结果都是 flow limmiting（限流）。这样不够友好，无法得知是限流还是降级还是授权拦截。</p>
<h3 id="4-2-1-异常类型"><a href="#4-2-1-异常类型" class="headerlink" title="4.2.1.异常类型"></a>4.2.1.异常类型</h3><p>而如果要自定义异常时的返回结果，需要实现 BlockExceptionHandler 接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BlockExceptionHandler</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理请求被限流、降级、授权拦截时抛出的异常：BlockException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, BlockException e)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个方法有三个参数：</p>
<ul>
<li>HttpServletRequest request：request 对象</li>
<li>HttpServletResponse response：response 对象</li>
<li>BlockException e：被 sentinel 拦截时抛出的异常</li>
</ul>
<p>这里的 BlockException 包含多个不同的子类：</p>
<table>
<thead>
<tr>
<th><strong>异常</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>FlowException</td>
<td>限流异常</td>
</tr>
<tr>
<td>ParamFlowException</td>
<td>热点参数限流的异常</td>
</tr>
<tr>
<td>DegradeException</td>
<td>降级异常</td>
</tr>
<tr>
<td>AuthorityException</td>
<td>授权规则异常</td>
</tr>
<tr>
<td>SystemBlockException</td>
<td>系统规则异常</td>
</tr>
</tbody></table>
<h3 id="4-2-2-自定义异常处理"><a href="#4-2-2-自定义异常处理" class="headerlink" title="4.2.2.自定义异常处理"></a>4.2.2.自定义异常处理</h3><p>下面，我们就在 order-service 定义一个自定义异常处理类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.itcast.order.sentinel;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.adapter.spring.webmvc.callback.BlockExceptionHandler;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.slots.block.BlockException;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.slots.block.authority.AuthorityException;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.slots.block.degrade.DegradeException;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.slots.block.flow.FlowException;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.slots.block.flow.param.ParamFlowException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SentinelExceptionHandler</span> <span class="keyword">implements</span> <span class="title class_">BlockExceptionHandler</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, BlockException e)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;未知异常&quot;</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">status</span> <span class="operator">=</span> <span class="number">429</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (e <span class="keyword">instanceof</span> FlowException) &#123;</span><br><span class="line">            msg = <span class="string">&quot;请求被限流了&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> ParamFlowException) &#123;</span><br><span class="line">            msg = <span class="string">&quot;请求被热点参数限流&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> DegradeException) &#123;</span><br><span class="line">            msg = <span class="string">&quot;请求被降级了&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> AuthorityException) &#123;</span><br><span class="line">            msg = <span class="string">&quot;没有权限访问&quot;</span>;</span><br><span class="line">            status = <span class="number">401</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json;charset=utf-8&quot;</span>);</span><br><span class="line">        response.setStatus(status);</span><br><span class="line">        response.getWriter().println(<span class="string">&quot;&#123;\&quot;msg\&quot;: &quot;</span> + msg + <span class="string">&quot;, \&quot;status\&quot;: &quot;</span> + status + <span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重启测试，在不同场景下，会返回不同的异常消息.</p>
<p>限流：</p>
<p><img src="D:/BaiDuDisk/BaiduNetdiskDownload/学习资料/day01-微服务保护/讲义/assets/image-20210716153938887.png" alt="image-20210716153938887"></p>
<p>授权拦截时：</p>
<p><img src="D:/BaiDuDisk/BaiduNetdiskDownload/学习资料/day01-微服务保护/讲义/assets/image-20210716154012736.png" alt="image-20210716154012736"></p>
<h1 id="5-规则持久化"><a href="#5-规则持久化" class="headerlink" title="5.规则持久化"></a>5.规则持久化</h1><p>现在，sentinel 的所有规则都是内存存储，重启后所有规则都会丢失。在生产环境下，我们必须确保这些规则的持久化，避免丢失。</p>
<h2 id="5-1-规则管理模式"><a href="#5-1-规则管理模式" class="headerlink" title="5.1.规则管理模式"></a>5.1.规则管理模式</h2><p>规则是否能持久化，取决于规则管理模式，sentinel 支持三种规则管理模式：</p>
<ul>
<li>原始模式：Sentinel 的默认模式，将规则保存在内存，重启服务会丢失。</li>
<li>pull 模式</li>
<li>push 模式</li>
</ul>
<h3 id="5-1-1-pull-模式"><a href="#5-1-1-pull-模式" class="headerlink" title="5.1.1.pull 模式"></a>5.1.1.pull 模式</h3><p>pull 模式：控制台将配置的规则推送到 Sentinel 客户端，而客户端会将配置规则保存在本地文件或数据库中。以后会定时去本地文件或数据库中查询，更新本地规则。</p>
<p><img src="D:/BaiDuDisk/BaiduNetdiskDownload/学习资料/day01-微服务保护/讲义/assets/image-20210716154155238.png" alt="image-20210716154155238"></p>
<h3 id="5-1-2-push-模式"><a href="#5-1-2-push-模式" class="headerlink" title="5.1.2.push 模式"></a>5.1.2.push 模式</h3><p>push 模式：控制台将配置规则推送到远程配置中心，例如 Nacos。Sentinel 客户端监听 Nacos，获取配置变更的推送消息，完成本地配置更新。</p>
<p><img src="D:/BaiDuDisk/BaiduNetdiskDownload/学习资料/day01-微服务保护/讲义/assets/image-20210716154215456.png" alt="image-20210716154215456"></p>
<h2 id="5-2-实现-push-模式"><a href="#5-2-实现-push-模式" class="headerlink" title="5.2.实现 push 模式"></a>5.2.实现 push 模式</h2><p>详细步骤可以参考课前资料的《sentinel 规则持久化》：</p>
<p><img src="/assets/image-20210716154255466.png" alt="image-20210716154255466"></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">首页</a></li>
        
          <li><a href="/about/">关于</a></li>
        
          <li><a href="/archives/">归档</a></li>
        
          <li><a target="_blank" rel="noopener" href="https://github.com/myHikari">项目</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Sentinel"><span class="toc-number">1.</span> <span class="toc-text">Sentinel</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E5%88%9D%E8%AF%86-Sentinel"><span class="toc-number">1.1.</span> <span class="toc-text">1、初识 Sentinel</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1%E3%80%81%E9%9B%AA%E5%B4%A9%E9%97%AE%E9%A2%98%E5%8F%8A%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.1、雪崩问题及解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-1%E3%80%81%E9%9B%AA%E5%B4%A9%E9%97%AE%E9%A2%98"><span class="toc-number">1.1.1.1.</span> <span class="toc-text">1.1.1、雪崩问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-2%E3%80%81%E8%B6%85%E6%97%B6%E5%A4%84%E7%90%86"><span class="toc-number">1.1.1.2.</span> <span class="toc-text">1.1.2、超时处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-3%E3%80%81%E4%BB%93%E5%A3%81%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.1.1.3.</span> <span class="toc-text">1.1.3、仓壁模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-4%E3%80%81%E6%96%AD%E8%B7%AF%E5%99%A8"><span class="toc-number">1.1.1.4.</span> <span class="toc-text">1.1.4、断路器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-5%E3%80%81%E9%99%90%E6%B5%81"><span class="toc-number">1.1.1.5.</span> <span class="toc-text">1.1.5、限流</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-6%E3%80%81%E6%80%BB%E7%BB%93"><span class="toc-number">1.1.1.6.</span> <span class="toc-text">1.1.6、总结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2%E3%80%81%E6%9C%8D%E5%8A%A1%E4%BF%9D%E6%8A%A4%E6%8A%80%E6%9C%AF%E5%AF%B9%E6%AF%94"><span class="toc-number">1.1.2.</span> <span class="toc-text">1.2、服务保护技术对比</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3%E3%80%81Sentinel-%E4%BB%8B%E7%BB%8D%E5%92%8C%E5%AE%89%E8%A3%85"><span class="toc-number">1.1.3.</span> <span class="toc-text">1.3、Sentinel 介绍和安装</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-1%E3%80%81%E5%88%9D%E8%AF%86-Sentinel"><span class="toc-number">1.1.3.1.</span> <span class="toc-text">1.3.1、初识 Sentinel</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-2%E3%80%81%E5%AE%89%E8%A3%85-Sentinel"><span class="toc-number">1.1.3.2.</span> <span class="toc-text">1.3.2、安装 Sentinel</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4%E3%80%81%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%95%B4%E5%90%88-Sentinel"><span class="toc-number">1.1.4.</span> <span class="toc-text">1.4、微服务整合 Sentinel</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6"><span class="toc-number">1.2.</span> <span class="toc-text">2、流量控制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1%E3%80%81%E7%B0%87%E7%82%B9%E9%93%BE%E8%B7%AF"><span class="toc-number">1.2.1.</span> <span class="toc-text">2.1、簇点链路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1%E3%80%81%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.1、快速入门</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2%E3%80%81%E6%B5%81%E6%8E%A7%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.2.3.</span> <span class="toc-text">2.2、流控模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1%E3%80%81%E5%85%B3%E8%81%94%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">2.2.1、关联模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-2%E3%80%81%E9%93%BE%E8%B7%AF%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.2.3.2.</span> <span class="toc-text">2.2.2、链路模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-3-%E6%80%BB%E7%BB%93"><span class="toc-number">1.2.3.3.</span> <span class="toc-text">2.2.3.总结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3%E3%80%81%E6%B5%81%E6%8E%A7%E6%95%88%E6%9E%9C"><span class="toc-number">1.2.4.</span> <span class="toc-text">2.3、流控效果</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-1%E3%80%81warm-up"><span class="toc-number">1.2.4.1.</span> <span class="toc-text">2.3.1、warm up</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B"><span class="toc-number">1.2.4.1.1.</span> <span class="toc-text">案例</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-2%E3%80%81%E6%8E%92%E9%98%9F%E7%AD%89%E5%BE%85"><span class="toc-number">1.2.4.2.</span> <span class="toc-text">2.3.2、排队等待</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B-1"><span class="toc-number">1.2.4.2.1.</span> <span class="toc-text">案例</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-3"><span class="toc-number">1.2.4.3.</span> <span class="toc-text">2.3.3</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">1.2.4.4.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4%E3%80%81%E7%83%AD%E7%82%B9%E5%8F%82%E6%95%B0%E9%99%90%E6%B5%81"><span class="toc-number">1.2.5.</span> <span class="toc-text">2.4、热点参数限流</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4-1%E3%80%81%E5%85%A8%E5%B1%80%E5%8F%82%E6%95%B0%E9%99%90%E6%B5%81"><span class="toc-number">1.2.5.0.1.</span> <span class="toc-text">2.4.1、全局参数限流</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4-2%E3%80%81%E7%83%AD%E7%82%B9%E5%8F%82%E6%95%B0%E9%99%90%E6%B5%81"><span class="toc-number">1.2.5.0.2.</span> <span class="toc-text">2.4.2、热点参数限流</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4-3%E3%80%81%E6%A1%88%E4%BE%8B"><span class="toc-number">1.2.5.0.3.</span> <span class="toc-text">2.4.3、案例</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-%E9%9A%94%E7%A6%BB%E5%92%8C%E9%99%8D%E7%BA%A7"><span class="toc-number">2.</span> <span class="toc-text">3.隔离和降级</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-FeignClient-%E6%95%B4%E5%90%88-Sentinel"><span class="toc-number">2.1.</span> <span class="toc-text">3.1.FeignClient 整合 Sentinel</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-1-%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%EF%BC%8C%E5%BC%80%E5%90%AF-sentinel-%E5%8A%9F%E8%83%BD"><span class="toc-number">2.1.1.</span> <span class="toc-text">3.1.1.修改配置，开启 sentinel 功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-2-%E7%BC%96%E5%86%99%E5%A4%B1%E8%B4%A5%E9%99%8D%E7%BA%A7%E9%80%BB%E8%BE%91"><span class="toc-number">2.1.2.</span> <span class="toc-text">3.1.2.编写失败降级逻辑</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-3-%E6%80%BB%E7%BB%93"><span class="toc-number">2.1.3.</span> <span class="toc-text">3.1.3.总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-%E7%BA%BF%E7%A8%8B%E9%9A%94%E7%A6%BB%EF%BC%88%E8%88%B1%E5%A3%81%E6%A8%A1%E5%BC%8F%EF%BC%89"><span class="toc-number">2.2.</span> <span class="toc-text">3.2.线程隔离（舱壁模式）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-1-%E7%BA%BF%E7%A8%8B%E9%9A%94%E7%A6%BB%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F"><span class="toc-number">2.2.1.</span> <span class="toc-text">3.2.1.线程隔离的实现方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-2-sentinel-%E7%9A%84%E7%BA%BF%E7%A8%8B%E9%9A%94%E7%A6%BB"><span class="toc-number">2.2.2.</span> <span class="toc-text">3.2.2.sentinel 的线程隔离</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%EF%BC%89%E9%85%8D%E7%BD%AE%E9%9A%94%E7%A6%BB%E8%A7%84%E5%88%99"><span class="toc-number">2.2.2.1.</span> <span class="toc-text">1）配置隔离规则</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%EF%BC%89Jmeter-%E6%B5%8B%E8%AF%95"><span class="toc-number">2.2.2.2.</span> <span class="toc-text">2）Jmeter 测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-3-%E6%80%BB%E7%BB%93"><span class="toc-number">2.2.3.</span> <span class="toc-text">3.2.3.总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7"><span class="toc-number">2.3.</span> <span class="toc-text">3.3.熔断降级</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-1-%E6%85%A2%E8%B0%83%E7%94%A8"><span class="toc-number">2.3.1.</span> <span class="toc-text">3.3.1.慢调用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%EF%BC%89%E8%AE%BE%E7%BD%AE%E6%85%A2%E8%B0%83%E7%94%A8"><span class="toc-number">2.3.1.1.</span> <span class="toc-text">1）设置慢调用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%EF%BC%89%E8%AE%BE%E7%BD%AE%E7%86%94%E6%96%AD%E8%A7%84%E5%88%99"><span class="toc-number">2.3.1.2.</span> <span class="toc-text">2）设置熔断规则</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%EF%BC%89%E6%B5%8B%E8%AF%95"><span class="toc-number">2.3.1.3.</span> <span class="toc-text">3）测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-2-%E5%BC%82%E5%B8%B8%E6%AF%94%E4%BE%8B%E3%80%81%E5%BC%82%E5%B8%B8%E6%95%B0"><span class="toc-number">2.3.2.</span> <span class="toc-text">3.3.2.异常比例、异常数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%EF%BC%89%E8%AE%BE%E7%BD%AE%E5%BC%82%E5%B8%B8%E8%AF%B7%E6%B1%82"><span class="toc-number">2.3.2.1.</span> <span class="toc-text">1）设置异常请求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%EF%BC%89%E8%AE%BE%E7%BD%AE%E7%86%94%E6%96%AD%E8%A7%84%E5%88%99-1"><span class="toc-number">2.3.2.2.</span> <span class="toc-text">2）设置熔断规则</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%EF%BC%89%E6%B5%8B%E8%AF%95-1"><span class="toc-number">2.3.2.3.</span> <span class="toc-text">3）测试</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-%E6%8E%88%E6%9D%83%E8%A7%84%E5%88%99"><span class="toc-number">3.</span> <span class="toc-text">4.授权规则</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-%E6%8E%88%E6%9D%83%E8%A7%84%E5%88%99"><span class="toc-number">3.1.</span> <span class="toc-text">4.1.授权规则</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-1-%E5%9F%BA%E6%9C%AC%E8%A7%84%E5%88%99"><span class="toc-number">3.1.1.</span> <span class="toc-text">4.1.1.基本规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-2-%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96-origin"><span class="toc-number">3.1.2.</span> <span class="toc-text">4.1.2.如何获取 origin</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-3-%E7%BB%99%E7%BD%91%E5%85%B3%E6%B7%BB%E5%8A%A0%E8%AF%B7%E6%B1%82%E5%A4%B4"><span class="toc-number">3.1.3.</span> <span class="toc-text">4.1.3.给网关添加请求头</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-4-%E9%85%8D%E7%BD%AE%E6%8E%88%E6%9D%83%E8%A7%84%E5%88%99"><span class="toc-number">3.1.4.</span> <span class="toc-text">4.1.4.配置授权规则</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BC%82%E5%B8%B8%E7%BB%93%E6%9E%9C"><span class="toc-number">3.2.</span> <span class="toc-text">4.2.自定义异常结果</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-1-%E5%BC%82%E5%B8%B8%E7%B1%BB%E5%9E%8B"><span class="toc-number">3.2.1.</span> <span class="toc-text">4.2.1.异常类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-2-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-number">3.2.2.</span> <span class="toc-text">4.2.2.自定义异常处理</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-%E8%A7%84%E5%88%99%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">4.</span> <span class="toc-text">5.规则持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-%E8%A7%84%E5%88%99%E7%AE%A1%E7%90%86%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.1.</span> <span class="toc-text">5.1.规则管理模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-1-pull-%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.1.1.</span> <span class="toc-text">5.1.1.pull 模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-2-push-%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.1.2.</span> <span class="toc-text">5.1.2.push 模式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-%E5%AE%9E%E7%8E%B0-push-%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.2.</span> <span class="toc-text">5.2.实现 push 模式</span></a></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://myhikari.github.io/2023/03/16/Sentinel/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://myhikari.github.io/2023/03/16/Sentinel/&text=Sentinel"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://myhikari.github.io/2023/03/16/Sentinel/&title=Sentinel"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://myhikari.github.io/2023/03/16/Sentinel/&is_video=false&description=Sentinel"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Sentinel&body=Check out this article: http://myhikari.github.io/2023/03/16/Sentinel/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://myhikari.github.io/2023/03/16/Sentinel/&title=Sentinel"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://myhikari.github.io/2023/03/16/Sentinel/&title=Sentinel"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://myhikari.github.io/2023/03/16/Sentinel/&title=Sentinel"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://myhikari.github.io/2023/03/16/Sentinel/&title=Sentinel"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://myhikari.github.io/2023/03/16/Sentinel/&name=Sentinel&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://myhikari.github.io/2023/03/16/Sentinel/&t=Sentinel"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2024
    myHikari
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">首页</a></li><!--
     --><!--
       --><li><a href="/about/">关于</a></li><!--
     --><!--
       --><li><a href="/archives/">归档</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/myHikari">项目</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板！\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功！");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
